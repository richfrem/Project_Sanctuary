flowchart TD
    Start([Start Snapshot Process])
    RenderDiagrams["Render Outdated Diagrams<br/>(Task #154)"]
    LoadManifest[Load Manifest<br/>.agent/learning/learning_audit/learning_audit_manifest.json]
    CheckType{Snapshot Type?}
    
    Start --> RenderDiagrams
    RenderDiagrams --> LoadManifest
    LoadManifest --> CheckType
    
    CheckType -- "audit/seal" --> GitCheck[Git Pre-Flight Check]
    CheckType -- "learning_audit" --> DedupeLogic[Protocol 130 Deduplication]
    
    subgraph "Protocol 130 Logic"
        DedupeLogic --> LoadRg[Load Registry<br>.agent/learning/manifest_registry.json]
        LoadRg -- "Read Map" --> MapOut[Map Output -> Source Manifest]
        MapOut -- "Check Each File" --> CheckFiles[Check Manifest Files]
        CheckFiles --> IsEmbedded{Is File Embedded?}
        IsEmbedded -- "Yes (In generated output)" --> RemoveSource[Remove Source Files]
        IsEmbedded -- "No (Unique)" --> KeepFile[Keep File]
        RemoveSource -- "Cleaned" --> FinalManifest[Final Deduped Manifest]
        KeepFile -- "Preserved" --> FinalManifest
    end
    
    FinalManifest -- "Proceed" --> GitCheck
    GitCheck --> Verify{Integrity OK?}
    
    Verify -- Yes --> Generate[Generate Snapshot<br>.agent/learning/learning_audit/learning_audit_packet.md]
    Verify -- No --> Fail([Fail / Safe Mode])
    
    Generate --> End([End])

    style DedupeLogic fill:#f9f,stroke:#333
    style FinalManifest fill:#bbf,stroke:#333
    style LoadRg fill:#dfd,stroke:#333
    style LoadManifest fill:#dfd,stroke:#333
