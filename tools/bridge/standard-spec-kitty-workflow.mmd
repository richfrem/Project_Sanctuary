graph TD
    %% Nodes - Feature Level (Start)
    Start(("Start Feature<br>(Start)"))
    Specify["fa:fa-file-alt Specify Feature<br>(Cmd: spec-kitty specify)"]
    VerifySpec["fa:fa-shield-alt Verify Specify<br>(verify_workflow_state.py --phase specify)"]
    Plan["fa:fa-map Plan Implementation<br>(Cmd: spec-kitty plan)"]
    VerifyPlan["fa:fa-shield-alt Verify Plan<br>(verify_workflow_state.py --phase plan)"]
    Tasks["fa:fa-tasks Generate Tasks<br>(Cmd: spec-kitty tasks)"]
    VerifyTasks["fa:fa-shield-alt Verify Tasks<br>(verify_workflow_state.py --phase tasks)"]

    %% Nodes - WP Level (Loop)
    subgraph WP_Loop["WP Execution Loop (Repeated per WP)"]
        Implement["fa:fa-tools Start WP<br>(Cmd: spec-kitty implement WP-xx)<br>(Creates: .worktrees/WP-xx)"]
        VerifyImpl["fa:fa-shield-alt Verify Implement<br>(verify_workflow_state.py --phase implement)"]
        Code["fa:fa-code Code & Test<br>(Context: Inside Worktree)"]
        Commit["fa:fa-save Git Commit (Local)<br>(git commit -m 'feat...')"]
        VerifyReview["fa:fa-shield-alt Verify Review<br>(verify_workflow_state.py --phase review)<br>(Worktree clean?)"]
        MoveReview["fa:fa-arrow-right Move to Review<br>(Cmd: spec-kitty agent tasks move-task)"]
        Review["fa:fa-glasses Review WP<br>(Cmd: spec-kitty review)<br>(Moves to 'Done')"]
    end

    %% Nodes - Feature Level (End)
    subgraph Completion["Feature Completion"]
        Accept["fa:fa-check-double Accept Feature<br>(Cmd: spec-kitty accept)<br>(Verifies All WPs Done)"]
        Merge["fa:fa-magic Spec-Kitty Merge (Automated)<br>(Cmd: spec-kitty merge)<br>(Context: Main Repo Root)<br>• Auto-Merges WPs<br>• Auto-Removes Worktrees<br>• Optional: Push"]
        End(("Feature Done<br>(Clean Repo)"))
    end

    %% Dual-Loop Mode (Optional)
    subgraph DualLoop["Dual-Loop Mode (Protocol 133)"]
        DL_Packet["Outer Loop: Generate<br>Strategy Packet"]
        DL_Handoff["Human Bridge:<br>Switch to Inner Loop"]
        DL_Execute["Inner Loop: Code<br>(No Git)"]
        DL_Return["Human Bridge:<br>Return to Outer Loop"]
        DL_Packet --> DL_Handoff --> DL_Execute --> DL_Return
    end

    %% Flow - Planning Phase
    Start --> Specify
    Specify --> VerifySpec
    VerifySpec --> Plan
    Plan --> VerifyPlan
    VerifyPlan --> Tasks
    Tasks --> VerifyTasks
    VerifyTasks --> Implement

    %% Loop Logic
    Implement --> VerifyImpl
    VerifyImpl -->|cd .worktrees/WP-xx| Code
    VerifyImpl -.->|Dual-Loop?| DL_Packet
    DL_Return -.-> Commit
    Code --> Commit
    Commit --> VerifyReview
    VerifyReview --> MoveReview
    MoveReview --> Review

    %% Iterate or Finish
    Review -->|Next WP?| Implement
    Review -->|All WPs Done?| Accept

    %% Finalization
    Accept --> Merge
    Merge --> End

    %% Styles
    classDef feature fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef wp fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef done fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef verify fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px;
    classDef dualloop fill:#cc99ff,stroke:#333,stroke-width:2px;

    class Specify,Plan,Tasks feature;
    class Implement,Code,Commit,MoveReview,Review wp;
    class Accept,Merge,End done;
    class VerifySpec,VerifyPlan,VerifyTasks,VerifyImpl,VerifyReview verify;
    class DL_Packet,DL_Handoff,DL_Execute,DL_Return dualloop;
