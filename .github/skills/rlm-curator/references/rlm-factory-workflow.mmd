sequenceDiagram
    participant User as User / Agent
    participant Config as rlm_config.py
    participant Auditor as inventory.py
    participant Cache as rlm_*_cache.json
    participant Distiller as distiller.py
    participant Ollama as Ollama (granite3.2:8b)
    participant FS as File System
    participant Query as query_cache.py
    participant Janitor as cleanup_cache.py

    Note over User, Janitor: Phase 1: Assess Coverage

    User->>Auditor: /rlm-factory:audit --type legacy
    Auditor->>Config: Load RLMConfig(type=legacy)
    Config-->>Auditor: Manifest paths, cache location
    Auditor->>Cache: Load existing entries
    Auditor->>FS: Scan target directories
    Auditor-->>User: ğŸ“Š Coverage: X% (N missing, M stale)

    Note over User, Janitor: Phase 2: Distill (Write â€” requires Ollama)

    User->>Distiller: /rlm-factory:distill
    Distiller->>Config: Load RLMConfig
    Distiller->>FS: Collect target files
    Distiller->>Cache: Load existing cache

    loop For each file not in cache (or hash changed)
        Distiller->>FS: Read file content
        Distiller->>Distiller: Compute content hash
        alt Hash unchanged (cache hit)
            Distiller->>Distiller: Skip
        else Hash changed or new file
            Distiller->>Ollama: POST /api/generate (content + prompt)
            Ollama-->>Distiller: Summary text
            Distiller->>Cache: Write entry (hash, summary, timestamp)
            Note right of Cache: Incremental persistence (write after EACH file)
        end
    end
    Distiller-->>User: âœ… Processed N files

    Note over User, Janitor: Phase 3: Query (Read â€” offline)

    User->>Query: /rlm-factory:query "search_term"
    Query->>Config: Load RLMConfig
    Query->>Cache: Load & search (path + summary substring)
    Query-->>User: ğŸ” Found N matches with summaries

    Note over User, Janitor: Phase 4: Cleanup (Curate â€” offline)

    User->>Janitor: /rlm-factory:cleanup --apply
    Janitor->>Config: Load RLMConfig
    Janitor->>Cache: Load existing entries
    loop For each cache entry
        Janitor->>FS: Check if file still exists
        alt File missing
            Janitor->>Janitor: Mark for removal
        else File exists but outside manifest
            Janitor->>Janitor: Mark as orphan
        end
    end
    Janitor->>Cache: Remove stale/orphan entries
    Janitor-->>User: ğŸ§¹ Removed N entries
