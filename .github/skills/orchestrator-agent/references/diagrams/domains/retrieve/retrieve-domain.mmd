flowchart TD
    User([User / Agent])
    
    subgraph CommandLayer [Retrieve Domain Interface]
        CmdBundle["/retrieve-bundle"]
        CmdSource["/retrieve-source"]
        CmdRLM["/retrieve-rlm-summary"]
        CmdGraph["/retrieve-dependency-graph"]
    end
    
    subgraph ToolLayer [Tier 1: Atomic Tools]
        Bundler["Context Bundler
        (bundle.py)"]
        RawView["Raw File View
        (view_file)"]
        Distiller["RLM Distiller
        (distiller.py)"]
        DepEngine["Dependency Engine
        (dependencies.py)"]
    end
    
    subgraph ArtifactLayer [File System & Data]
        DepMap[("dependency_map.json")]
        RLMCache[("RLM Cache
        (JSON)")]
        Vectors[("Vector DB")]
        SourceFiles[("Source Code
        (FMB/XML/PLL)")]
        Bundles[("Context Bundles
        (.md)")]
    end
    
    %% Flows
    User --> CmdBundle
    User --> CmdSource
    User --> CmdRLM
    User --> CmdGraph
    
    %% Bundle Flow
    CmdBundle --> Bundler
    Bundler -->|"Consults"| DepMap
    Bundler -->|"Reads"| SourceFiles
    Bundler -->|"Fetches"| RLMCache
    Bundler -->|"Generates"| Bundles
    Bundles -->|"Returns Content"| User
    
    %% Other Flows
    CmdSource --> RawView
    RawView --> SourceFiles
    
    CmdRLM --> Distiller
    Distiller --> RLMCache
    
    CmdGraph --> DepEngine
    DepEngine --> DepMap

    classDef command fill:#f9f,stroke:#333,stroke-width:2px;
    classDef tool fill:#bbf,stroke:#333,stroke-width:2px;
    classDef artifact fill:#ff9,stroke:#333,stroke-width:2px;
    
    class CmdBundle,CmdSource,CmdRLM,CmdGraph command;
    class Bundler,RawView,Distiller,DepEngine tool;
    class DepMap,RLMCache,Vectors,SourceFiles,Bundles artifact;
