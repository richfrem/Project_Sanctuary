============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
benchmark: 5.2.3 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/richardfremmerlid/Projects/Project_Sanctuary
configfile: pytest.ini
plugins: benchmark-5.2.3, anyio-4.9.0, langsmith-0.4.31, cov-6.2.1, typeguard-4.4.4
collecting ... collected 1 item

tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario 
-------------------------------- live log setup --------------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:21 Starting MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88033)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting agent_persona...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/agent_persona/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88034)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting chronicle...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/chronicle/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88035)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting code...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/code/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88036)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting config...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/config/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88037)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting council...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/council/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88038)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting forge_llm...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/forge_llm/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88039)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting git...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/git/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88040)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting orchestrator...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/orchestrator/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88041)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting protocol...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/protocol/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88042)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting rag_cortex...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/rag_cortex/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88043)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting task...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/task/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88044)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:45 Fleet started with 12 servers.
-------------------------------- live log call ---------------------------------
INFO     orchestrator.e2e.test_protocol_056_headless:test_protocol_056_headless.py:31 === Cycle 1: Validation Policy ===
INFO     orchestrator.e2e.test_protocol_056_headless:test_protocol_056_headless.py:40 Creating policy file at DOCS/TEST_056_Validation_Policy.md...
FAILED
------------------------------ live log teardown -------------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:49 Stopping MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping agent_persona...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping chronicle...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping code...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping config...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping council...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping forge_llm...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping git...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping orchestrator...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping protocol...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping rag_cortex...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping task...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped


=================================== FAILURES ===================================
______________ TestProtocol056Headless.test_triple_loop_scenario _______________

self = <orchestrator.e2e.test_protocol_056_headless.TestProtocol056Headless object at 0x10c3b1f90>
mcp_fleet = <tests.mcp_servers.base.mcp_server_fleet.MCPServerFleet object at 0x10c327770>

    @pytest.mark.e2e
    def test_triple_loop_scenario(self, mcp_fleet):
        """
        Executes the 3-cycle recursive validation loop using headless MCP servers.
    
        Ref: TASKS/in-progress/109_implement_protocol_056_headless_tripleloop_e2e_tes.md
        """
        # 1. Setup Clients
        code_client = mcp_fleet.get_client("code")
        cortex_client = mcp_fleet.get_client("rag_cortex")
        chronicle_client = mcp_fleet.get_client("chronicle")
    
        # Ensure we have a clean slate or known state
        # (Optional: check server status)
    
        # --- Cycle 1: Validation Policy ---
        logger.info("=== Cycle 1: Validation Policy ===")
        policy_path = "DOCS/TEST_056_Validation_Policy.md"
        policy_content = (
            "# Protocol 056 Validation Policy\n\n"
            "The Guardian confirms Validation Protocol 056 is active.\n"
            "This document serves as the root of trust for the recursive validation loop."
        )
    
        # Action: Create file
        logger.info(f"Creating policy file at {policy_path}...")
>       result = code_client.call_tool("code_write", {
            "path": policy_path,
            "content": policy_content
        })

tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.mcp_servers.base.mcp_test_client.MCPTestClient object at 0x10c38d810>
name = 'code_write'
arguments = {'content': '# Protocol 056 Validation Policy\n\nThe Guardian confirms Validation Protocol 056 is active.\nThis document serves as the root of trust for the recursive validation loop.', 'path': 'DOCS/TEST_056_Validation_Policy.md'}

    def call_tool(self, name: str, arguments: Dict[str, Any] = {}) -> Any:
        """Call an MCP tool and return the result."""
        self.request_id += 1
        request = {
            "jsonrpc": "2.0",
            "id": self.request_id,
            "method": "tools/call",
            "params": {
                "name": name,
                "arguments": arguments
            }
        }
    
        # Send Request
        if not self.process or not self.process.stdin:
            raise RuntimeError("Server not running")
    
        json_str = json.dumps(request) + "\n"
        self.process.stdin.write(json_str)
        self.process.stdin.flush()
    
        # Read Response
        # Note: In a real protocol, we might receive notifications or other requests.
        # This simple client assumes request-response for now.
        while True:
            response = self._read_response()
    
            if response.get("id") == self.request_id:
                if "error" in response:
>                   raise RuntimeError(f"Tool execution failed: {response['error']}")
E                   RuntimeError: Tool execution failed: {'code': -32602, 'message': 'Invalid request parameters', 'data': ''}

tests/mcp_servers/base/mcp_test_client.py:103: RuntimeError
------------------------------ Captured log setup ------------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:21 Starting MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88033)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting agent_persona...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/agent_persona/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88034)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting chronicle...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/chronicle/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88035)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting code...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/code/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88036)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting config...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/config/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88037)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting council...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/council/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88038)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting forge_llm...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/forge_llm/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88039)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting git...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/git/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88040)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting orchestrator...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/orchestrator/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88041)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting protocol...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/protocol/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88042)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting rag_cortex...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/rag_cortex/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88043)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting task...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:29 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/task/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:40 Server started (PID 88044)
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:45 Fleet started with 12 servers.
------------------------------ Captured log call -------------------------------
INFO     orchestrator.e2e.test_protocol_056_headless:test_protocol_056_headless.py:31 === Cycle 1: Validation Policy ===
INFO     orchestrator.e2e.test_protocol_056_headless:test_protocol_056_headless.py:40 Creating policy file at DOCS/TEST_056_Validation_Policy.md...
---------------------------- Captured log teardown -----------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:49 Stopping MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping agent_persona...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping chronicle...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping code...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping config...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping council...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping forge_llm...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping git...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping orchestrator...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping protocol...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping rag_cortex...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:51 Stopping task...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:50 Server stopped
=========================== short test summary info ============================
FAILED tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario
============================== 1 failed in 5.57s ===============================
