============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
benchmark: 5.2.3 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/richardfremmerlid/Projects/Project_Sanctuary
configfile: pytest.ini
plugins: benchmark-5.2.3, anyio-4.9.0, langsmith-0.4.31, cov-6.2.1, typeguard-4.4.4
collecting ... collected 1 item

tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario FAILED

=================================== FAILURES ===================================
______________ TestProtocol056Headless.test_triple_loop_scenario _______________

self = <orchestrator.e2e.test_protocol_056_headless.TestProtocol056Headless object at 0x10cd35f90>
mcp_fleet = <tests.mcp_servers.base.mcp_server_fleet.MCPServerFleet object at 0x10ccab770>

    @pytest.mark.e2e
    def test_triple_loop_scenario(self, mcp_fleet):
        """
        Executes the 3-cycle recursive validation loop using headless MCP servers.
    
        Ref: TASKS/in-progress/109_implement_protocol_056_headless_tripleloop_e2e_tes.md
        """
        # 1. Setup Clients
        code_client = mcp_fleet.get_client("code")
        cortex_client = mcp_fleet.get_client("rag_cortex")
        chronicle_client = mcp_fleet.get_client("chronicle")
    
        # Ensure we have a clean slate or known state
        # (Optional: check server status)
    
        # --- Cycle 1: Validation Policy ---
        logger.info("=== Cycle 1: Validation Policy ===")
        policy_path = "DOCS/TEST_056_Validation_Policy.md"
        policy_content = (
            "# Protocol 056 Validation Policy\n\n"
            "The Guardian confirms Validation Protocol 056 is active.\n"
            "This document serves as the root of trust for the recursive validation loop."
        )
    
        # Action: Create file
        logger.info(f"Creating policy file at {policy_path}...")
>       result = code_client.call_tool("code_write", {
            "path": policy_path,
            "content": policy_content
        })

tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py:41: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.mcp_servers.base.mcp_test_client.MCPTestClient object at 0x10cd11480>
name = 'code_write'
arguments = {'content': '# Protocol 056 Validation Policy\n\nThe Guardian confirms Validation Protocol 056 is active.\nThis document serves as the root of trust for the recursive validation loop.', 'path': 'DOCS/TEST_056_Validation_Policy.md'}

    def call_tool(self, name: str, arguments: Dict[str, Any] = {}) -> Any:
        """Call an MCP tool and return the result."""
        self.request_id += 1
        request = {
            "jsonrpc": "2.0",
            "id": self.request_id,
            "method": "tools/call",
            "params": {
                "name": name,
                "arguments": arguments
            }
        }
    
        # Send Request
        if not self.process or not self.process.stdin:
            raise RuntimeError("Server not running")
    
        json_str = json.dumps(request) + "\n"
        self.process.stdin.write(json_str)
        self.process.stdin.flush()
    
        # Read Response
        # Note: In a real protocol, we might receive notifications or other requests.
        # This simple client assumes request-response for now.
        while True:
            response = self._read_response()
    
            if response.get("id") == self.request_id:
                if "error" in response:
>                   raise RuntimeError(f"Tool execution failed: {response['error']}")
E                   RuntimeError: Tool execution failed: {'code': -32602, 'message': 'Invalid request parameters', 'data': ''}

tests/mcp_servers/base/mcp_test_client.py:103: RuntimeError
=========================== short test summary info ============================
FAILED tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario
============================== 1 failed in 5.66s ===============================
