============================= test session starts ==============================
platform darwin -- Python 3.13.4, pytest-8.4.1, pluggy-1.6.0 -- /usr/local/bin/python3
cachedir: .pytest_cache
benchmark: 5.2.3 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/richardfremmerlid/Projects/Project_Sanctuary
configfile: pytest.ini
plugins: benchmark-5.2.3, anyio-4.9.0, langsmith-0.4.31, cov-6.2.1, typeguard-4.4.4
collecting ... collected 1 item

tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario 
-------------------------------- live log setup --------------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:21 Starting MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:31 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:43 Server started (PID 91330)
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:102 Server stopped
ERROR

==================================== ERRORS ====================================
_____ ERROR at setup of TestProtocol056Headless.test_triple_loop_scenario ______

self = <tests.mcp_servers.base.mcp_test_client.MCPTestClient object at 0x1086f8050>
env = {'ANTIGRAVITY_AGENT': '1', 'ANTIGRAVITY_CLI_ALIAS': 'agy', 'BUNDLED_DEBUGPY_PATH': '/Users/richardfremmerlid/.antigravity/extensions/ms-python.debugpy-2025.14.1-darwin-arm64/bundled/libs/debugpy', 'COLORTERM': 'truecolor', ...}

    def start(self, env: Optional[Dict[str, str]] = None):
        """Start the MCP server subprocess."""
        # Use sys.executable to ensure we use the same Python environment
        cmd = [sys.executable, str(self.server_path)]
        logger.info(f"Starting MCP Server: {' '.join(cmd)}")
    
        # Line buffering usually requires env var or -u, but bufsize=1 + text=True helps in Python
        self.process = subprocess.Popen(
            cmd,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE, # Capture stderr to prevent noise
            text=True,
            bufsize=1, # Line buffered
            env=env or os.environ.copy()
        )
        logger.info(f"Server started (PID {self.process.pid})")
    
        # Perform Initialization Handshake
        try:
>           self.initialize()

tests/mcp_servers/base/mcp_test_client.py:47: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/mcp_servers/base/mcp_test_client.py:75: in initialize
    resp = self._read_response()
           ^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.mcp_servers.base.mcp_test_client.MCPTestClient object at 0x1086f8050>

    def _read_response(self) -> Dict[str, Any]:
        """Blocking read of the next JSON-RPC message from stdout."""
        if not self.process or not self.process.stdout:
            raise RuntimeError("Server not running")
    
        while True:
            line = self.process.stdout.readline()
            if not line:
                stderr = self.process.stderr.read() if self.process.stderr else ""
>               raise EOFError(f"Server closed connection. Stderr: {stderr}")
E               EOFError: Server closed connection. Stderr: Traceback (most recent call last):
E                 File "/Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py", line 6, in <module>
E                   from .operations import ADROperations
E               ImportError: attempted relative import with no known parent package

tests/mcp_servers/base/mcp_test_client.py:113: EOFError

During handling of the above exception, another exception occurred:

    @pytest.fixture(scope="session")
    def mcp_fleet():
        """
        Session-scoped fixture that starts the entire MCP server fleet.
        Yields an MCPServerFleet instance.
        """
        from tests.mcp_servers.base.mcp_server_fleet import MCPServerFleet
        fleet = MCPServerFleet()
>       fleet.start_all()

tests/mcp_servers/conftest.py:96: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/mcp_servers/base/mcp_server_fleet.py:42: in start_all
    client.start(env=env)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.mcp_servers.base.mcp_test_client.MCPTestClient object at 0x1086f8050>
env = {'ANTIGRAVITY_AGENT': '1', 'ANTIGRAVITY_CLI_ALIAS': 'agy', 'BUNDLED_DEBUGPY_PATH': '/Users/richardfremmerlid/.antigravity/extensions/ms-python.debugpy-2025.14.1-darwin-arm64/bundled/libs/debugpy', 'COLORTERM': 'truecolor', ...}

    def start(self, env: Optional[Dict[str, str]] = None):
        """Start the MCP server subprocess."""
        # Use sys.executable to ensure we use the same Python environment
        cmd = [sys.executable, str(self.server_path)]
        logger.info(f"Starting MCP Server: {' '.join(cmd)}")
    
        # Line buffering usually requires env var or -u, but bufsize=1 + text=True helps in Python
        self.process = subprocess.Popen(
            cmd,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE, # Capture stderr to prevent noise
            text=True,
            bufsize=1, # Line buffered
            env=env or os.environ.copy()
        )
        logger.info(f"Server started (PID {self.process.pid})")
    
        # Perform Initialization Handshake
        try:
            self.initialize()
        except Exception as e:
            self.stop()
>           raise RuntimeError(f"Failed to initialize server: {e}")
E           RuntimeError: Failed to initialize server: Server closed connection. Stderr: Traceback (most recent call last):
E             File "/Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py", line 6, in <module>
E               from .operations import ADROperations
E           ImportError: attempted relative import with no known parent package

tests/mcp_servers/base/mcp_test_client.py:50: RuntimeError
------------------------------ Captured log setup ------------------------------
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:21 Starting MCP Server Fleet...
INFO     tests.mcp_servers.base.mcp_server_fleet:mcp_server_fleet.py:40 Booting adr...
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:31 Starting MCP Server: /usr/local/bin/python3 /Users/richardfremmerlid/Projects/Project_Sanctuary/mcp_servers/adr/server.py
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:43 Server started (PID 91330)
INFO     tests.mcp_servers.base.mcp_test_client:mcp_test_client.py:102 Server stopped
=========================== short test summary info ============================
ERROR tests/mcp_servers/orchestrator/e2e/test_protocol_056_headless.py::TestProtocol056Headless::test_triple_loop_scenario
=============================== 1 error in 2.06s ===============================
