# ==============================================================================
# CANONICAL TRAINING CONFIGURATION for Project Sanctuary (v1.0)
# ==============================================================================
# This file centralizes all parameters for the fine-tuning process, replacing
# the hardcoded constants in the original 'build_lora_adapter.py' script.
# It is located within the OPERATION_PHOENIX_FORGE directory to keep all
# fine-tuning assets organized.
#
# HIGHLIGHTS FROM LLM MODELS (Gemini, Grok4, ChatGPT):
# - Reducing max_seq_length from 512 to 256 is proven for 3-4x speedup (O(nÂ²) attention reduction).
# - Community benchmarks show 2-4x faster steps on 8GB GPUs with minimal quality loss.
# - Trade-offs: Shorter context (sufficient for instruction tuning), lower VRAM (4-6GB vs 7-8GB).
# - Additional optimizations: Increase grad accumulation to 8, use fp16, save every 200 steps.
# - Added: Validation/eval, gradient checkpointing, narrower LoRA targets, dataloader opts, seed.
# ==============================================================================

# --- Model & Output Configuration ---
model:
  base_model_name: "Qwen/Qwen2-7B-Instruct"   # The Hugging Face model identifier to download.
  # The final, trained LoRA adapter will be saved here, relative to the project root.
  final_adapter_path: "models/Sanctuary-Qwen2-7B-v1.0-adapter"

# --- Dataset Configuration ---
data:
  # Path to your training data file, relative to the project root.
  train_file: "dataset_package/sanctuary_whole_genome_data.jsonl"
  # It's highly recommended to also have a validation set to monitor for overfitting.
  val_file: "dataset_package/sanctuary_whole_genome_data_val.jsonl" # Placeholder for future use.

# --- Hardware & Performance Configuration ---
# Updated: 256 is proven for 3-4x speedup on 8GB GPUs with minimal trade-offs (shorter context, lower VRAM).
max_seq_length: 256
# Updated: Use fp16 for better compatibility on A2000 (supports fp16 over bf16).
use_bf16: false
torch_dtype: "float16"  # Explicit dtype for HF loader/Trainer consistency

# --- Quantization Configuration (for QLoRA) ---
# These settings enable 4-bit quantization to drastically reduce memory usage.
quantization:
  load_in_4bit: true
  bnb_4bit_quant_type: "nf4"          # Use the "nf4" type for higher precision.
  bnb_4bit_compute_dtype: "float16"   # Updated: Match fp16 training dtype.
  bnb_4bit_use_double_quant: true     # Saves an additional ~0.4 bits per parameter.

# --- LoRA (Low-Rank Adaptation) Configuration ---
# These settings define the structure of the trainable adapter.
lora:
  r: 16                                 # LoRA rank. Lower rank saves memory. 16 is a good balance.
  lora_alpha: 32                        # Standard practice is to set alpha = 2 * r.
  lora_dropout: 0.1                     # Dropout for regularization.
  bias: "none"                          # Do not train bias terms.
  task_type: "CAUSAL_LM"                # This is a causal language model.
  # These are the specific layers within the Qwen2 model that we will adapt.
  target_modules:
    - "q_proj"
    - "v_proj"
    - "up_proj"
    - "down_proj"

# --- Training Arguments Configuration ---
# These parameters are passed directly to the Hugging Face SFTTrainer.
training:
  # Directory where intermediate checkpoints will be saved during training.
  output_dir: "outputs/checkpoints/Sanctuary-Qwen2-7B-v1.0"
  num_train_epochs: 3                   # The total number of training epochs.
  per_device_train_batch_size: 1        # Process one example at a time per device.
  gradient_accumulation_steps: 8        # Updated: Accumulate over 8 steps for better GPU utilization (effective batch 8).
  optim: "paged_adamw_8bit"             # Memory-efficient optimizer.
  logging_steps: 25                     # Updated: Log every 25 steps for balance.
  learning_rate: 2e-4                   # The initial learning rate.
  max_grad_norm: 0.3                    # Helps prevent exploding gradients.
  warmup_ratio: 0.03                    # A small portion of training is used to warm up the learning rate.
  lr_scheduler_type: "cosine"           # The learning rate will decrease following a cosine curve.
  save_strategy: "steps"                # Updated: Save every N steps for resuming.
  save_steps: 200                       # Updated: Save checkpoint every 200 steps.
  save_total_limit: 3                   # Prevents disk bloat by keeping only 3 checkpoints.
  fp16: true                            # Updated: Enable fp16 for A2000 compatibility.
  gradient_checkpointing: true          # Reduces peak VRAM at slight speed cost.
  eval_strategy: "steps"          # Enable evaluation during training.
  eval_steps: 200                       # Run evaluation every 200 steps.
  load_best_model_at_end: true          # Load the best model at end.
  metric_for_best_model: "loss"         # Use loss to select best model.
  dataloader_num_workers: 2             # Speed up data loading.
  dataloader_pin_memory: true           # Pin memory for faster GPU transfer.
  seed: 42                              # For reproducibility.
  report_to: "none"                     # Disable reporting to external services like W&B for now.