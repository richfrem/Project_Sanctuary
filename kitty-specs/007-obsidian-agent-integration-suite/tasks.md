# Work Packages: Obsidian Agent Integration Suite

**Inputs**: Design documents from `/kitty-specs/007-obsidian-agent-integration-suite/`
**Prerequisites**: plan.md (required), spec.md (user stories).

**Tests**: Only include explicit testing work when stakeholders request it.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`. Treat this file as the high-level checklist; keep deep implementation detail inside the prompt files.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel within the same context.
- Include precise file paths or modules.

---

## Work Package WP01: Research Obsidian Integration Strategy & Capability Overlap (Priority: P1)

**Goal**: Determine strategy and assess capability overlap with RLM/Vector DB.
**Independent Test**: ADR approved detailing the chosen architecture and capability pivot points.
**Prompt**: `/tasks/WP01-research-integration-strategy.md`

### Included Subtasks
- [x] T001 Analyze Obsidian's core mechanisms (Local REST API, direct Markdown, Custom Plugin) relative to the Agent Client Protocol (ACP) integrations.
- [x] T002 Analyze capability overlap with `rlm-factory` and `vector-db` plugins.
- [x] T003 Architect explicitly how Project Sanctuary agents will leverage Obsidian skills (Markdown Mastery, Obsidian Bases, JSON Canvas) and define the necessary plugin boundaries.
- [x] T004 Draft ADR detailing the chosen read/write strategy, capability alignment, and required software installations (Obsidian CLI).
- [x] T005 Obtain human steward approval on the ADR.

### Implementation Notes
- Crucial that WP01 is completely resolved before WP05 and WP06 begin.

### Dependencies
- None.

---

## Work Package WP02: Deep Analyze Kepano Obsidian Skills Repository (Priority: P1)

**Goal**: Clone the `kepano/obsidian-skills` repo to glean architecture context.
**Independent Test**: Summary document outlining patterns discovered.
**Prompt**: `/tasks/WP02-analyze-kepano-skills.md`

### Included Subtasks
- [x] T006 Clone `https://github.com/kepano/obsidian-skills` to a secure temp directory.
- [x] T007 Analyze the tools and agent integrations mapped in that repo.
- [x] T008 Compare Kepano's plugin approach to the Sanctuary direct-filesystem approach.
- [x] T009 Compile an architectural synthesis payload for the context bundler.
- [x] T010 Clean up the repository from `/tmp`.

### Implementation Notes
- Should inform the plugin design mapped out in WP01 ADR.

### Dependencies
- None.

---

## Work Package WP03: Research Data Mapping to HF Schema (Priority: P2)

**Goal**: Define JSONL data mapping rules and explicitly ignore attachment logic.
**Independent Test**: ADR approved defining the `source_path` flattening strategy.
**Prompt**: `/tasks/WP03-research-hf-schema-mapping.md`

### Included Subtasks
- [x] T011 Analyze HF `soul_traces.jsonl` schema (ADR 081).
- [x] T012 Define exact mapping rules for nested folders via `source_path`.
- [x] T013 Formalize the rule that images and binary attachments are strictly ignored.
- [x] T014 Draft ADR detailing the mapping strategy.
- [x] T015 Obtain human steward approval on the mapping ADR.

### Dependencies
- WP01

---

## Work Package WP04: Legacy Scrubbing & Automated Link Refactoring (Priority: P3)

**Goal**: Remove obsolete architecture and fix broken repo paths.
**Independent Test**: 0 broken links, 0 'MCP' usages in core setup.
**Prompt**: `/tasks/WP04-legacy-scrubbing.md`

### Included Subtasks
- [x] T016 Develop a dry-run enabled script to convert `[Link](../../file.md)` into Obsidian wikilinks `[[file]]`.
- [x] T017 Apply refactoring across `01_PROTOCOLS/` and `02_LEARNING/` directories.
- [x] T018 Scrub "MCP" references from `sanctuary-guardian-prompt.md`.
- [x] T019 Verify clean grep results for obsolete syntax.

### Dependencies
- None.

---

## Work Package WP05: Build Obsidian Markdown Mastery Skill (Priority: P1)

**Goal**: Build the format controller and shared `obsidian-parser`.
**Independent Test**: Can reliably parse varying link syntaxes (`[[Note|Alias]]`, Embeds).
**Prompt**: `/tasks/WP05-build-markdown-mastery.md`

### Included Subtasks
- [x] T020 Scaffold the `obsidian-markdown-mastery` skill framework.
- [x] T021 Build the shared `obsidian-parser` module for deep wikilink inspection.
- [x] T022 Handle block reference, heading, alias, and embed mappings.
- [x] T023 Implement Callout parsing logic according to Obsidian flavors.
- [x] T024 Write parsing tests ensuring edge cases are caught.

### Dependencies
- WP01, WP02

---

## Work Package WP06: Build Obsidian Vault CRUD Skill (Priority: P1)

**Goal**: Establish base agent skill for note interaction.
**Independent Test**: Create, read, and append to a note autonomously.
**Prompt**: `/tasks/WP06-build-obsidian-crud.md`

### Included Subtasks
- [ ] T025 Scaffold the `obsidian-vault-crud` plugin directory.
- [ ] T026 Implement atomic writes (write `.tmp`, `os.rename`) to prevent partial corruption.
- [ ] T027 Implement an `.agent-lock` advisory lock protocol before writing.
- [ ] T028 Check file `mtime` to detect concurrent user edits mid-operation.
- [ ] T029 Enforce lossless YAML parsing with `ruamel.yaml`.

### Dependencies
- WP01, WP05

---

## Work Package WP07: Build Obsidian Dynamic Views Skills (Bases & Canvas) (Priority: P2)

**Goal**: Enable reading/writing `.base` and `.canvas` files natively.
**Independent Test**: Safely parse, modify, and export a JSON canvas definition.
**Prompt**: `/tasks/WP07-build-dynamic-views.md`

### Included Subtasks
- [ ] T030 Scaffold `obsidian-bases-manager` and `obsidian-canvas-architect` plugins.
- [ ] T031 Implement `.base` table/grid manipulation logic preserving structure.
- [ ] T032 Build `json-canvas-spec` 1.0 logic to programmaticly draw nodes and edges.
- [ ] T033 Handle malformed JSON/YAML by degrading gracefully and reporting format errors.
- [ ] T034 Verify operations against standard schemas.

### Dependencies
- WP01, WP06

---

## Work Package WP08: Build Obsidian Graph Traversal Skill (Priority: P2)

**Goal**: Enable semantic link traversal for context bridging.
**Independent Test**: Identify a 5-node relationship accurately in < 2s.
**Prompt**: `/tasks/WP08-build-graph-traversal.md`

### Included Subtasks
- [ ] T035 Scaffold `obsidian-graph-traversal` plugin directory.
- [ ] T036 Integrate the `obsidian-parser` from WP05 to analyze edge links.
- [ ] T037 Build an in-memory graph index cache to answer queries without full scans.
- [ ] T038 Implement fast backlink and forward-link resolution methods.
- [ ] T039 Execute verify tests proving sub-2 second query returns.

### Dependencies
- WP05, WP06

---

## Work Package WP09: Build 'Forge Soul' Semantic Exporter Skill (Priority: P2)

**Goal**: Securely format and export sealed knowledge to Hugging Face JSONL.
**Independent Test**: Valid JSONL push after passing Git verification gate.
**Prompt**: `/tasks/WP09-build-forge-soul.md`

### Included Subtasks
- [ ] T040 Scaffold `forge-soul-exporter` plugin.
- [ ] T041 Implement Git Pre-Flight check across both standard Repo and isolated Vault root.
- [ ] T042 Identify `status: sealed` notes, failing gracefully if frontmatter is corrupt.
- [ ] T043 Apply Snapshot Isolation parity checks (aborting if tree hashes change mid-run).
- [ ] T044 Formulate payload according to WP03 schema rules.
- [ ] T045 Build Hugging Face export step enforcing exponential backoff for rate limits.

### Dependencies
- WP03, WP06

---

## Work Package WP10: Phase 1.5 Integration & Synthetic Edge-Case Testing (Priority: P2)

**Goal**: End-to-end traversal mapping across edge-cases.
**Independent Test**: Agent correctly traverses malformed data.
**Prompt**: `/tasks/WP10-integration-testing.md`

### Included Subtasks
- [ ] T046 Spin up a synthetic Test Vault decoupled from live data.
- [ ] T047 Seed 100+ edge-case notes (malformed YAML, broken links, deeply nested transclusions).
- [ ] T048 Run CRUD + Graph logic on the vault concurrently.
- [ ] T049 Perform a dry-run test of the Forge Soul export.
- [ ] T050 Collect coverage results and flag errors.

### Dependencies
- WP04, WP07, WP08, WP09
