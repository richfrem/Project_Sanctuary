---
config:
  layout: dagre
  theme: base
---

%% Name: Protocol 128: Learning Loop (v5.0 - Agent Loops Orchestration)
%% Description: Orchestrated Cognitive Continuity workflow with multi-pattern execution

flowchart TB
    subgraph subGraphScout["I. Guardian: Session Start & Scout (skill: guardian-onboarding)"]
        direction TB
        Start["Session Start<br>(session-bootloader skill)"] --> Primer["Read File: cognitive_primer.md"]
        
        ContextNote["â„¹ï¸ Context: Executed within Standard Hybrid Workflow"] -.-> Start
        
        Primer --> Wakeup["Script: guardian_wakeup.py"]
        Wakeup --> IronCheckGate1{Iron Check?}
        
        IronCheckGate1 -- PASS --> Debrief["Script: learning_debrief.py"]
        IronCheckGate1 -- FAIL --> SafeMode1[SAFE MODE<br>Read-Only / Halt]
        
        Debrief --> SeekTruth["Context Acquired"]
        
        SuccessorSnapshot["Truth Anchor:<br>learning_package_snapshot.md"] -.->|Embedded| SeekTruth
        BootDeps["ðŸ”— Consumes:<br>rlm-factory (cache read)<br>env-helper (project root)"] -.-> Wakeup
    end

    InvokeOrch["Invoke Orchestrator<br>(agent_orchestrator.py)"]

    subgraph subGraphOrchestrator["II. Orchestrator: Routing & Loops (skill: orchestrator)"]
        direction TB
        Router{"Task Router"}
        OrchestratorNote["ðŸ”— Consumes: plugins/agent-loops/skills/orchestrator/"] -.-> Router
    end

    subgraph pathLearning["Path 1: Simple Learning Loop (skill: learning-loop)"]
        direction TB
        L_Synth["Synthesis<br>(Record ADRs/Notes)"] --> L_Gate{"Strategic Gate<br>(HITL)"}
    end

    subgraph pathRedTeam["Path 2: Red Team Review Loop (skill: red-team-review)"]
        direction TB
        RT_Research["Capture Research"] --> RT_Bundle["Bundle Context"]
        RT_Bundle --> RT_Feedback{"Red Team Feedback"}
        RT_Feedback -- "More Research" --> RT_Research
        RT_Feedback -- "Ready" --> TechApproval{"Gate 2: HITL"}
    end

    subgraph pathDualLoop["Path 3: Dual-Loop Delegation (skill: dual-loop)"]
        direction TB
        DL_Plan["Outer Loop: Plan & Partition"] --> DL_Packet["Generate Strategy Packet"]
        DL_Packet --> DL_Inner["Inner Loop: Execute (No Git)"]
        DL_Inner --> DL_Verify{"Outer Loop: Verify"}
        DL_Verify -- "Fail" --> DL_Correct["Generate Correction Packet"]
        DL_Correct --> DL_Inner
    end

    subgraph pathSwarm["Path 4: Agent Swarm (skill: agent-swarm)"]
        direction TB
        S_Partition["Partition Work"] --> S_Dispatch["Dispatch N Worktrees"]
        S_Dispatch --> S_Execute["Agents Execute in Isolation"]
        S_Execute --> S_Verify{"Verify & Merge"}
        S_Verify -- "Fail" --> S_Dispatch
    end
    
    SeekTruth --> InvokeOrch
    InvokeOrch --> Router
    Router -- "Research/Docs" --> L_Synth
    Router -- "Architecture/Review" --> RT_Research
    Router -- "Single Work Package" --> DL_Plan
    Router -- "Large Feature/Bulk" --> S_Partition

    Convergence(("Closure<br>Initiated"))

    L_Gate -- "PASS" --> Convergence
    TechApproval -- "PASS" --> Convergence
    DL_Verify -- "Pass" --> Convergence
    S_Verify -- "Pass" --> Convergence

    subgraph PhaseV ["V: Orchestrator Retrospective"]
        direction TB
        Retro["Loop Retrospective"]
        Improve["Improve Loop Infrastructure"]
        Retro --> Improve
    end

    subgraph subGraphSeal["VI. Guardian: Technical Seal (skill: guardian-onboarding)"]
        direction TB
        TriggerRLM["Trigger: RLM Synthesizer"]
        WriteHologram["Write: learning_package_snapshot.md"]
        CaptureSeal["Script: capture_snapshot.py --type seal"]
        SealCheck{Iron Check?}
        SealDeps["ðŸ”— Consumes:<br>rlm-factory (synthesis)<br>context-bundler (bundle)"] -.-> CaptureSeal
        
        TriggerRLM --> WriteHologram --> CaptureSeal --> SealCheck
        SealCheck -- FAIL --> SafeMode2[SAFE MODE]
        SealCheck -- PASS --> SealSuccess[Seal Applied]
    end

    subgraph subGraphPersist["VII. Guardian: Soul Persistence (skill: guardian-onboarding)"]
        direction TB
        PersistOps["Script: persist_soul.py"]
        PersistDeps["ðŸ”— Consumes:<br>env-helper (HF creds)<br>huggingface_hub"] -.-> PersistOps
        
        subgraph HF_Repo["HuggingFace: Project_Sanctuary_Soul"]
            MD_Seal["lineage/MODEL_seal.md"]
            JSONL_Traces["data/soul_traces.jsonl"]
        end
    end

    subgraph PhaseVIII ["VIII: Relational Ingestion & Closure"]
        direction TB
        Ingest["Script: vector_db ingest (optional)"]
        GitOps["Git Ops"]
        End["Orchestrator: agent_orchestrator.py end"]
        Ingest --> GitOps --> End
    end

    %% Final Connections
    Convergence --> Retro
    Improve --> TriggerRLM
    SealSuccess --> PersistOps
    PersistOps --> JSONL_Traces
    PersistOps --> MD_Seal
    JSONL_Traces --> Ingest
    End -- "Cycle Complete" --> Start
    
    %% Error Handlers
    L_Gate -- "FAIL" --> Retro
    TechApproval -- "FAIL" --> Retro
    SealCheck -- "FAIL" --> Retro

    %% Styling
    style Router fill:#f3e5f5,stroke:#9c27b0,stroke-width:3px
    style PhaseV fill:#d4edda,stroke:#155724,stroke-width:2px
    style subGraphSeal fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style subGraphPersist fill:#cce5ff,stroke:#004085,stroke-width:2px
    style PhaseVIII fill:#fff3cd,stroke:#856404,stroke-width:2px