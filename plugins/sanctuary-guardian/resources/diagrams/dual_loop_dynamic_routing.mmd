flowchart TD
    %% ----------------------------------------------------
    %% Dual-Loop Dynamic Routing & Orchestration
    %% ----------------------------------------------------

    %% Styles
    classDef strategy fill:#99ccff,stroke:#333,stroke-width:2px;
    classDef router fill:#ffa347,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5;
    classDef execution fill:#cc99ff,stroke:#333,stroke-width:2px;
    classDef storage fill:#ffff99,stroke:#333,stroke-width:1px;

    %% ----------------------------------------------------
    %% 1. STRATEGIC SUPERVISOR (Outer Loop)
    %% ----------------------------------------------------
    subgraph Supervisor ["Strategic Supervisor (Outer Loop)"]
        direction TB
        AgentOrchestrator["Agent Orchestrator<br>(Planning & Delegation)"]:::strategy
        SpecKitty["Spec Kitty<br>(Specs & Tasks)"]:::strategy
        
        AgentOrchestrator -->|Defines| SpecKitty
        SpecKitty -->|Generates| TaskList["Task Packet<br>(.agent/handoffs/)"]:::storage
        
        NoteOuter[Any High-Reasoning Agent via chat or CLI <br>e.g. Antigravity, Gemini 3, Claude Opus 4.6]:::strategy
    end

    %% ----------------------------------------------------
    %% 2. INTELLIGENT ROUTER
    %% ----------------------------------------------------
    TaskList --> Router{"Task Classifier<br>& Cost Router"}:::router

    %% ----------------------------------------------------
    %% 3. EXECUTION LAYERS (Inner Loops)
    %% ----------------------------------------------------
    subgraph Execution ["Execution Layer (Inner Loops)"]
        direction TB
        
        %% Path A: Complex / Architectural
        Router -->|"Complex Logic<br>High Risk"| HighReason["High-Reasoning CLI<br>(e.g. Claude Opus, Gemini Ultra)"]:::execution
        
        %% Path B: Routine / Bulk
        Router -->|"Routine Tasks<br>Tests/Docs"| FastReason["Fast/Efficient CLI<br>(e.g. Haiku, Flash, Cortex)"]:::execution
        
        %% Path C: Specialized Personas (Any CLI)
        Router -->|"Security Audit"| SecAgent["Security Specialist CLI<br>(e.g. generic-red-team)"]:::execution
        Router -->|"QA / Testing"| QAAgent["QA/Test Runner CLI"]:::execution
        Router -->|"Database"| DBAgent["DB/Migration CLI"]:::execution
    end

    %% ----------------------------------------------------
    %% 4. FEEDBACK & MERGE
    %% ----------------------------------------------------
    HighReason -->|Code| Verify["Verification"]:::strategy
    FastReason -->|Code| Verify
    SecAgent -->|Report| Verify
    QAAgent -->|Report| Verify
    DBAgent -->|Schema| Verify

    Verify -->|Pass| Merge["Merge & Close"]:::strategy
    Verify -->|Fail| Correction["Correction Packet"]:::storage
    Correction --> Router
