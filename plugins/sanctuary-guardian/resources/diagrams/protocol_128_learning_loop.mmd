%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#ffffff', 'primaryBorderColor': '#333333', 'primaryTextColor': '#333333', 'lineColor': '#666666'}}}%%
graph TD
    %% ==========================================
    %% Entry Points (Phase I)
    %% ==========================================
    subgraph PhaseI ["Phase I: The Orientation (Session Bootloader)"]
        direction TB
        Start("Start Agent Session<br/>(IDE/CLI/MCP)"):::entry
        Wakeup["Script: guardian_wakeup.py<br/>(Iron Check & Boot Digest)"]
        Debrief["Script: learning_debrief.py<br/>(Load Previous Truth Anchor)"]
        ReadPrimer["Read: cognitive_primer.md<br/>(Protocol 128 Alignment)"]
        
        Start --> Wakeup
        Wakeup --> Debrief
        Debrief --> ReadPrimer
    end
    style PhaseI fill:#e8f4f8,stroke:#0277bd,stroke-width:2px

    %% ==========================================
    %% Strategic Framing (Spec-Kitty Integration)
    %% ==========================================
    subgraph SpecKitty ["Strategic Framing: Spec-Kitty (Tri-Track System)"]
        direction TB
        IsFeature{"Is this a new<br/>feature or complex task?"}
        
        TrackA["Track A: Factory<br/>(Standardized Workflows)"]:::track
        TrackB["Track B: Discovery<br/>(Custom Features)"]:::track
        TrackC["Track C: Micro-Tasks<br/>(Maintenance)"]:::track
        
        Spec["1. Specify: spec.md<br/>(/spec-kitty.specify)"]
        Plan["2. Plan: plan.md<br/>(/spec-kitty.plan)"]
        Tasks["3. Tasks: tasks/WP-*.md<br/>(/spec-kitty.tasks)"]
        
        IsFeature -- "Yes (Custom)" --> TrackB
        TrackB --> Spec --> Plan --> Tasks
        IsFeature -- "Standard Routine" --> TrackA
        IsFeature -- "Trivial Fix" --> TrackC
    end
    style SpecKitty fill:#fff8e1,stroke:#f57f17,stroke-width:2px
    
    ReadPrimer --> IsFeature

    %% ==========================================
    %% Execution (Agent Loops & Orchestrator)
    %% ==========================================
    subgraph Execution ["Execution via Orchestrator (Patterns 1-4)"]
        direction TB
        Router{"Orchestrator:<br/>Loop Router"}
        
        P1["Pattern 1:<br/>Learning Loop<br/>(Research/Docs)"]:::pattern
        P2["Pattern 2:<br/>Red Team Review<br/>(Adversarial Audit)"]:::pattern
        P3["Pattern 3:<br/>Dual-Loop<br/>(Strategic/Tactical)"]:::pattern
        P4["Pattern 4:<br/>Agent Swarm<br/>(Parallel Execution)"]:::pattern
        
        Router --> P1
        Router --> P2
        Router --> P3
        Router --> P4
    end
    style Execution fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px

    %% Linking Tracks to Execution
    Tasks --> Router
    TrackA --> Router
    TrackC --> Router

    %% ==========================================
    %% Unified Closure (Phase V-VIII)
    %% ==========================================
    subgraph Closure ["Unified Closure Sequence (Guardian & Orchestrator)"]
        direction TB
        
        Retro["Phase V: Loop Retrospective<br/>(agent_orchestrator.py retro)"]
        Seal["Phase VI: Technical Seal<br/>(capture_snapshot.py --seal)"]
        Persist["Phase VII: Soul Persistence<br/>(persist_soul.py)"]
        Git["Phase VIII: Git Ops & Closure<br/>(agent_orchestrator.py end)"]
        
        P1 & P2 & P3 & P4 --> Retro
        
        Retro --> Seal
        Seal --> Persist
        Persist --> Git
    end
    style Closure fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px

    %% Failure & Recovery Paths
    Retro -. "Critique / Learn" .-> Router
    Seal -- "Iron Check Failed" --> SafeMode(("SAFE MODE<br/>HALT")):::alert

    %% Styling classes
    classDef default font-family:sans-serif
    classDef entry fill:#bbdefb,stroke:#1565c0,color:black,stroke-width:2px
    classDef track fill:#ffe0b2,stroke:#ef6c00,color:black
    classDef pattern fill:#e1bee7,stroke:#8e24aa,color:black
    classDef alert fill:#ffcdd2,stroke:#c62828,color:black,stroke-width:3px