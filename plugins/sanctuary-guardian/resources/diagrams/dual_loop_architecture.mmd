flowchart TD
    %% ----------------------------------------------------
    %% Dual-Loop Agent Architecture (Protocol 133 + 128)
    %% ----------------------------------------------------

    %% Colors
    classDef human fill:#ff9966,stroke:#333,stroke-width:2px;
    classDef outer fill:#99ccff,stroke:#333,stroke-width:2px;
    classDef inner fill:#cc99ff,stroke:#333,stroke-width:2px;
    classDef storage fill:#ffff99,stroke:#333,stroke-width:2px;

    %% Actors
    User([User / Human Bridge]):::human

    %% ----------------------------------------------------
    %% PHASE I: STRATEGY (Outer Loop)
    %% ----------------------------------------------------
    subgraph OuterStrategy ["Phase I: Strategy (Outer Loop)"]
        direction TB

        Start(["Start"]):::outer --> Scout[I. Scout: Boot & Orient]:::outer
        Scout -->|Read Boot Files| Context[(RLM / Spec Context)]:::storage

        Scout --> SpecKitty[Spec Kitty: Specify → Plan → Tasks]:::outer
        SpecKitty -->|Verify| StateCheck[verify_workflow_state.py<br>--phase tasks]:::outer
        StateCheck --> Worktree[Create Worktree<br>/spec-kitty.implement]:::outer
        Worktree --> PacketGen[Generate Strategy Packet<br>generate_strategy_packet.py]:::outer
        PacketGen -->|Output| Packet[".agent/handoffs/<br>task_packet_NNN.md"]:::storage
    end

    %% ----------------------------------------------------
    %% PHASE II: HAND-OFF (Human Bridge)
    %% ----------------------------------------------------
    Packet -->|Signal 'Ready'| User
    User -->|Launch Claude| InnerStart([Inner Loop Terminal]):::inner

    %% ----------------------------------------------------
    %% PHASE III: EXECUTION (Inner Loop)
    %% ----------------------------------------------------
    subgraph InnerExec ["Phase III: Execution (Inner Loop)"]
        direction TB

        InnerStart --> ReadPacket[Read Strategy Packet]:::inner
        ReadPacket --> Code[Write Code & Run Tests]:::inner
        Code -->|No Git| Verify[Self-Verify vs Criteria]:::inner
        Verify --> Done[Signal Completion]:::inner
    end

    Done -->|Return| User
    User -->|Switch to Outer Loop| VerifyStart(["Resume Outer Loop"]):::outer

    %% ----------------------------------------------------
    %% PHASE IV: VERIFICATION (Outer Loop)
    %% ----------------------------------------------------
    subgraph Verification ["Phase IV: Verification (Outer Loop)"]
        direction TB
        VerifyStart --> DiffCheck[verify_inner_loop_result.py<br>Inspect Diff + Criteria]:::outer
        DiffCheck --> CleanCheck[verify_workflow_state.py<br>--phase review]:::outer
        CleanCheck --> Decision{Pass?}:::outer

        Decision -- No --> Correction[Auto-generate<br>correction_packet_NNN.md]:::outer
        Correction -->|Delta Fix| User

        Decision -- Yes --> Commit[Commit in Worktree]:::outer
        Commit --> LaneUpdate[Update Task Lane → done]:::outer
    end

    %% ----------------------------------------------------
    %% PHASE V+: CLOSURE (Protocol 128)
    %% ----------------------------------------------------
    subgraph Closure ["Phase V+: Closure (Protocol 128)"]
        direction TB
        LaneUpdate --> Seal[VI. Seal]:::outer
        Seal --> Persist[VII. Persist → HuggingFace]:::outer
        Persist --> Retro[VIII. Retrospective]:::outer
        Retro --> End([IX. End]):::outer
    end

    %% Fallback
    subgraph FallbackMode ["Fallback: Branch-Direct"]
        direction TB
        FallbackNote[Inner Loop codes on<br>feature branch directly<br>Log in friction log]:::inner
    end
    style FallbackMode fill:#fff3e0,stroke:#e65100,stroke-width:2px,stroke-dasharray: 5 5

    InnerStart -.->|worktree unavailable| FallbackNote
    FallbackNote -.->|completion| User
