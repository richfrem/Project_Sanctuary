# Dependency Management Guide
**JUSTIN Modernization Project**

## Overview

This project uses multiple technology stacks that each require dependency management:
- **Python** - Analysis tools, migration scripts, form relationship analysis
- **Node.js** - XML-to-markdown conversion, Next.js frontends
- **.NET** - Backend APIs and services

## Python Dependency Management

### Core Principles
1.  **Locked Files**: Always use `requirements.txt` files, never manual `pip install`.
2.  **Intent vs. Truth**:
    -   `requirements.in` files = **Human Intent** (what you edit).
    -   `requirements.txt` files = **Machine Truth** (generated by `pip-compile`).
3.  **Consistency**: Same lockfiles used for local development and containers.

### Python Tools in This Project

| Tool | Location | Purpose |
|------|----------|---------|
| **XML-to-Markdown** | `tools/xml-to-markdown/` | Converts Oracle Forms XML to markdown |
| **Form Relationships** | `tools/form-relationships/` | Analyzes form dependencies |
| **Migration Scripts** | `scripts/` | Path migration and form stub generation |

### Adding a Python Dependency

**Step 1: Identify the correct scope**

For XML-to-markdown tool:
```bash
# Edit the intent file
vim tools/xml-to-markdown/requirements.in
```

For analysis scripts:
```bash
# Edit the intent file
vim tools/form-relationships/requirements.in
```

**Step 2: Add the package**
```text
# Example: requirements.in
lxml>=4.9.0
pandas>=2.0.0
```

**Step 3: Generate lockfile**
```bash
# Generate the locked requirements.txt
pip-compile tools/xml-to-markdown/requirements.in \
  --output-file tools/xml-to-markdown/requirements.txt
```

**Step 4: Install locally**
```bash
# Install from lockfile
pip install -r tools/xml-to-markdown/requirements.txt
```

### Updating Python Dependencies

**DO NOT EDIT `.txt` FILES MANUALLY.**

Update a specific package:
```bash
pip-compile --upgrade-package pandas tools/xml-to-markdown/requirements.in
```

Update all packages:
```bash
pip-compile --upgrade tools/xml-to-markdown/requirements.in
```

## Node.js Dependency Management

### Core Principles
1.  **Lock is Truth**: `package-lock.json` is the single source of truth. Never ignore it.
2.  **Intent vs. Truth**:
    -   `package.json` = **Human Intent** (semver ranges, e.g., `^18.2.0`).
    -   `package-lock.json` = **Machine Truth** (exact versions, e.g., `18.2.0`).
3.  **Strict Installs**: Use `npm ci` (Clean Install) for reproducible environments.

### Tools Using Node.js

| Tool | Location | Purpose |
|------|----------|---------|
| **XML-to-Markdown** | `tools/xml-to-markdown/` | Form conversion (uses Jest, Babel) |
| **RCC Frontend** | `modernization/apps/RCC/next-js/` | React + Next.js application |
| **JAS Frontend** | `modernization/apps/JAS/next-js/` | React + Next.js application |
| **JCS Frontend** | `modernization/apps/JCS/next-js/` | React + Next.js application |
| **JRS Frontend** | `modernization/apps/JRS/next-js/` | React + Next.js application |
| **LEA Frontend** | `modernization/apps/LEA/next-js/` | React + Next.js application |

### Managing Node.js Dependencies

**1. Installing Dependencies (The Standard)**
Use **Clean Install** for setting up projects, CI/CD pipelines, or switching branches.
```bash
npm ci
```
*Why?* Unlike `npm install`, this deletes `node_modules` and installs **exactly** what is in `package-lock.json`. It functions like Python's `pip install -r requirements.txt`.
**Rule:** If `npm ci` fails because `package-lock.json` is out of sync with `package.json`, do NOT force it. Fix the lockfile.

**2. Adding a Dependency (Modifying Intent)**
```bash
cd modernization/apps/RCC/next-js
npm install <package-name>
# This updates package.json (Intent) AND regenerates package-lock.json (Truth)
```

**3. Updating Dependencies**
```bash
# Update versions within the ranges allowed in package.json
npm update

# For resolving "ERESOLVE" / Peer Dependency issues (Common in Monorepos)
npm install <package-name> --legacy-peer-deps
```

**4. Fixing Lockfile Issues**
If your lockfile gets messy or `npm ci` fails:
```bash
rm -rf node_modules package-lock.json
npm install
# Validate that the only changes are the ones you expect
git diff package-lock.json
```

## .NET Dependency Management

### .NET Projects

| Project | Location | Purpose |
|---------|----------|---------|
| **Common Services** | `modernization/apps/common/dotnet/` | Shared business logic |
| **RCC.Api** | `modernization/apps/RCC/dotnet/` | RCC backend API |
| **JAS.Api** | `modernization/apps/JAS/dotnet/` | JAS backend API |
| **JCS.Api** | `modernization/apps/JCS/dotnet/` | JCS backend API |
| **JRS.Api** | `modernization/apps/JRS/dotnet/` | JRS backend API |
| **LEA.Api** | `modernization/apps/LEA/dotnet/` | LEA backend API |

### Managing .NET Dependencies

**Adding a NuGet package:**
```bash
cd modernization/apps/RCC/dotnet
dotnet add package EntityFrameworkCore
```

**Updating packages:**
```bash
dotnet restore
dotnet list package --outdated
dotnet add package <PackageName> --version <NewVersion>
```

**Package references:**
All dependencies are tracked in `.csproj` files:
```xml
<ItemGroup>
  <PackageReference Include="Microsoft.EntityFrameworkCore" Version="8.0.0" />
  <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.0" />
</ItemGroup>
```

## Best Practices

### For All Languages

1. **Lock Everything**: Always commit lockfiles (`requirements.txt`, `package-lock.json`, `.csproj`)
2. **Review Updates**: Check breaking changes before upgrading major versions
3. **Security First**: Regularly update dependencies for security patches
4. **Document Constraints**: Note any version constraints in README files

### Version Control

**Always Commit:**
- `requirements.txt` (Python)
- `package-lock.json` (Node.js)
- `*.csproj` files (.NET)

**Never Commit:**
- `node_modules/` (covered by `.gitignore`)
- `bin/`, `obj/` (.NET build outputs)
- `__pycache__/`, `*.pyc` (Python bytecode)
- `venv/`, `.venv/` (Virtual environments)
