# Plugin Migration Guide
> For agents adopting the `plugins/` architecture in a new or existing repo.

## Plugin Catalog

| Plugin | Description | Has Scripts | Deps |
|:---|:---|:---:|:---|
| `adr-manager` | Create/list/search Architecture Decision Records with auto-numbering | ✅ (2) | None |
| `agent-orchestrator` | Dual-loop agent delegation (Outer=plan, Inner=execute) | ✅ (1) | spec-kitty-cli |
| `claude-cli` | Pipe large contexts to Anthropic models with persona-based analysis | ❌ | claude CLI |
| `code-snapshot` | Bundle repo files into token-counted, role-specific context packages | ✅ (3) | tiktoken |
| `coding-conventions` | Code standards and header templates (Python/TS/C#) | ❌ | None |
| `context-bundler` | Bundle source files into single-file LLM context packages | ✅ (3) | None |
| `dependency-management` | pip-compile locked-file workflow reference | ❌ | pip-tools |
| `link-checker` | Validate \u0026 auto-repair broken documentation links | ✅ (3) | None |
| `mermaid-export` | Render .mmd diagrams to PNG/SVG | ✅ (1) | node, @mermaid-js/mermaid-cli |
| `plugin-bridge` | Universal Installer — maps plugins to agent environments | ✅ (1) | None |
| `rlm-factory` | Distill semantic summaries using Ollama for context retrieval | ✅ (5) | ollama, requests |
| `spec-kitty` | Spec-Driven Development lifecycle + Universal Bridge sync | ✅ (5) | spec-kitty-cli |
| `task-manager` | JSON-backed kanban board (backlog/todo/in-progress/done) | ✅ (1) | None |
| `tool-inventory` | Tool registries + embedded ChromaDB for semantic discovery | ✅ (7) | chromadb |
| `vector-db` | Semantic search via ChromaDB + Super-RAG context injection | ✅ (4) | chromadb, sentence-transformers |

> **Excluded**: `chronicle-manager`, `protocol-manager` (project-specific, not portable).

---

## Plugin Anatomy (Standard)

```
plugins/<name>/
├── .claude-plugin/
│   └── plugin.json          # Manifest (name, version, deps, keywords)
├── commands/                # Slash commands (*.md)
│   └── <action>.md          # /plugin-name:action
├── scripts/                 # Implementation (*.py, *.sh)
│   └── <tool>.py
├── skills/                  # Agent persona / SKILL.md
│   └── <skill-name>/
│       └── SKILL.md
├── docs/                    # Architecture diagrams, etc.
└── README.md
```

---

## Migration Strategy (6 Phases)

### Phase 1: Inventory Old Tools
Build a JSON manifest of every existing tool reference.

```bash
# Agent should create: migration_inventory.json
{
  "tools/codify/vector/ingest.py": {
    "new_path": "plugins/vector-db/scripts/ingest.py",
    "references_found": 12,
    "status": "pending"
  },
  "tools/retrieve/rlm/query_cache.py": {
    "new_path": "plugins/rlm-factory/scripts/query_cache.py",
    "references_found": 8,
    "status": "pending"
  }
}
```

**How to build**:
1. List all `.py` files under `tools/` (exclude `cli.py`).
2. For each, use `grep -r` to count references across the repo.
3. Map each to its new `plugins/` path using the table below.
4. Save as `migration_inventory.json`.

### Phase 2: Inventory Old Workflows/Skills/Rules
Same approach for non-script artifacts:

```bash
# Scan these directories:
# .agent/workflows/     → commands/ in the relevant plugin
# .agent/skills/        → skills/ in the relevant plugin
# .agent/rules/         → stays (rules are project-specific config)
# .claude/commands/     → generated by plugin-bridge
# .github/prompts/      → generated by plugin-bridge
# .gemini/commands/     → generated by plugin-bridge
```

### Phase 3: Update `cli.py` References
The CLI router (`tools/cli.py`) contains hardcoded paths. Update these:

```python
# OLD (scattered across tools/)
DOCS_DIR = Path(resolve_path("tools/codify/documentation"))
RLM_DIR = Path(resolve_path("tools/retrieve/rlm"))
INVENTORIES_DIR = Path(resolve_path("tools/curate/inventories"))

# NEW (consolidated in plugins/)
RLM_DIR = Path(resolve_path("plugins/rlm-factory/scripts"))
INVENTORIES_DIR = Path(resolve_path("plugins/tool-inventory/scripts"))
```

> [!IMPORTANT]
> Keep `tools/cli.py` as the main entry point. Only update the path constants it references.

### Phase 4: Search \u0026 Replace Script
Create a temporary migration script:

```python
#!/usr/bin/env python3
"""migration_replace.py — Batch update tool references."""
import json, re
from pathlib import Path

# Load inventory
with open("migration_inventory.json") as f:
    inventory = json.load(f)

# File extensions to scan
SCAN_EXTS = {".py", ".md", ".sh", ".yaml", ".yml", ".json", ".toml"}
SKIP_DIRS = {".git", "node_modules", "__pycache__", ".venv"}

def scan_and_replace(root: Path):
    for path in root.rglob("*"):
        if path.is_file() and path.suffix in SCAN_EXTS:
            if any(skip in path.parts for skip in SKIP_DIRS):
                continue
            content = path.read_text(errors="ignore")
            changed = False
            for old_path, info in inventory.items():
                if old_path in content:
                    content = content.replace(old_path, info["new_path"])
                    info["status"] = "replaced"
                    changed = True
            if changed:
                path.write_text(content)
                print(f"  Updated: {path}")

    # Save updated inventory
    with open("migration_inventory.json", "w") as f:
        json.dump(inventory, f, indent=2)

if __name__ == "__main__":
    scan_and_replace(Path("."))
```

### Phase 5: Install via Plugin Bridge
After all references point to `plugins/`, run the bridge to populate agent-specific directories:

```bash
# Install all plugins to all detected environments
for plugin in plugins/*/; do
    python3 plugins/plugin-bridge/scripts/bridge_installer.py --plugin "$plugin"
done
```

This auto-populates:
- `.agent/workflows/`, `.agent/skills/` (Antigravity)
- `.claude/commands/` (Claude Desktop)
- `.github/prompts/` (Copilot)
- `.gemini/commands/` (Gemini)

### Phase 6: Cleanup Old Directories
Once all references are confirmed updated:

```bash
# Remove old scattered tool directories (ONLY after verification)
# DO NOT delete tools/cli.py or tools/orchestrator/
rm -rf tools/codify/
rm -rf tools/retrieve/
rm -rf tools/curate/
rm -rf tools/investigate/
rm -rf tools/standalone/
rm -rf tools/bridge/
```

> [!CAUTION]
> Only delete after running the migration script AND verifying all tests pass. Create a git branch first.

---

## Known Old → New Path Mappings

| Old Path | New Plugin Path |
|:---|:---|
| `tools/codify/vector/ingest.py` | `plugins/vector-db/scripts/ingest.py` |
| `tools/retrieve/vector/query.py` | `plugins/vector-db/scripts/query.py` |
| `tools/curate/vector/cleanup.py` | `plugins/vector-db/scripts/cleanup.py` |
| `tools/codify/rlm/distiller.py` | `plugins/rlm-factory/scripts/distiller.py` |
| `tools/retrieve/rlm/query_cache.py` | `plugins/rlm-factory/scripts/query_cache.py` |
| `tools/curate/inventories/manage_tool_inventory.py` | `plugins/tool-inventory/scripts/manage_tool_inventory.py` |
| `tools/codify/documentation/check_broken_paths.py` | `plugins/link-checker/scripts/check_broken_paths.py` |
| `tools/codify/documentation/map_repository_files.py` | `plugins/link-checker/scripts/map_repository_files.py` |
| `tools/retrieve/bundler/bundle.py` | `plugins/context-bundler/scripts/bundle.py` |
| `tools/bridge/speckit_system_bridge.py` | `plugins/spec-kitty/scripts/speckit_system_bridge.py` |
| `tools/bridge/sync_workflows.py` | `plugins/spec-kitty/scripts/sync_workflows.py` |
| `tools/bridge/sync_rules.py` | `plugins/spec-kitty/scripts/sync_rules.py` |

> This table is a starting point. The agent should build the complete inventory in Phase 1.

---

## Checklist for Target Agent

- [ ] Copy `plugins/` directory (minus `chronicle-manager`, `protocol-manager`) to target repo
- [ ] Run Phase 1: Build `migration_inventory.json`
- [ ] Run Phase 2: Inventory workflows/skills/rules
- [ ] Run Phase 3: Update `cli.py` path constants
- [ ] Run Phase 4: Execute `migration_replace.py`
- [ ] Run Phase 5: `plugin-bridge` install all
- [ ] Run Phase 6: Clean up old `tools/` subdirs
- [ ] Verify: All scripts run, no broken imports
- [ ] Git: Commit on feature branch, test, then merge
