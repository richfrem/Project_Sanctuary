sequenceDiagram
    participant User as User
    participant Browser as Web Browser: Valuation Wizard (UI Modal)
    participant Backend as Node.js Backend & LLM
    participant DB as JSON Storage

    Note over User, DB: Scenario: Assessing NVDA Valuation (All Interactions in BROWSER)

    User->>Browser: Clicks "AI Analysis" on Stock Card
    Browser->>Backend: Request Context (Metrics + Logic)
    
    Backend->>Python (Process): spawn('python3 fetch_financials.py NVDA')
    Python (Process)->>yfinance: Download Ticker Data
    yfinance-->>Python (Process): Return Raw Data
    Python (Process)-->>Backend: Return Clean JSON (PE, RuleOf40, etc)

    Backend-->>Browser: Return Live Metrics (PE: 65x, Growth: 94%)
    
    Browser->>Browser: Opens Modal (Left: Metrics, Right: Chat)
    Browser-->>User: Displays Prompt: "PE 35x assumes 50% growth. Sustainable?"

    User->>Browser: Types in Chat: "No, 25% growth is realistic."
    
    Note right of Browser: BROWSER NEVER TALKS TO LLM
    Browser->>Backend: API: POST /analyze-input (Secure Gateway)
    
    Backend->>Backend: Build Prompt (System: "You are Valuation Expert" + User Input + Metrics)
    
    Note right of Backend: Uses @google/generative-ai SDK
    Backend->>LLM (Gemini): model.generateContent(prompt)
    LLM (Gemini)-->>Backend: Return JSON (Gemini 3 Pro)
    
    Backend->>Backend: Parse JSON & Update Model State
    Backend-->>Browser: Return New State (Growth: 25%, FV: $120)

    Browser-->>User: "Fair Value: $120. Save as 'Bear Case'?"
    
    User->>Browser: Clicks "Yes, Save"
    Browser->>Backend: Save Target ($120, "Bear", Rationale="Competition")
    Backend->>DB: Write to user_targets.json
    DB-->>Backend: OK
    Backend-->>Browser: Success
    Browser-->>User: Update Stock Card with Tag: "User Target: $120 (Bear)"
