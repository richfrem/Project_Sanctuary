 sequenceDiagram
    participant User as User
    participant Browser as Web Browser: Thesis Widget (Dashboard)
    participant Backend as Node.js Backend & LLM
    participant Files as Filesystem (Thesis.md & Portfolio.json)

    Note over User, Files: Scenario: Quarterly Portfolio Check (Tool B)

    User->>Browser: Opens Dashboard (Passive View)
    Browser->>Backend: GET /api/analysis/thesis/health
    
    Backend->>Files: Read "Twin Revolutions.md" (Plan)
    Files-->>Backend: Return Markdown Content
    Backend->>Backend: Parse Targets (e.g. "Compute = 28%")
    
    Backend->>Files: Read "portfolio.json" (Current Holdings)
    Files-->>Backend: Return Positions (e.g. "INTC = 5%")
    
    Backend->>Backend: Calculate Drift (Target - Actual)
    Backend-->>Browser: Return JSON { "compute_drift": -0.06, "alerts": ["Underweight Compute"] }

    Browser-->>User: Display Red Bar on Widget: "Compute: 22% (Target 28%)"

    User->>Browser: Clicks "Optimize Portfolio" (Active)
    
    Note right of Browser: BROWSER NEVER TALKS TO LLM
    Browser->>Backend: POST /api/analysis/thesis/optimize (Drift Data)
    
    Backend->>Backend: Build Prompt (System: "You are Portfolio Balancer" + Drift + Current Prices)
    
    Note right of Backend: Uses @google/generative-ai SDK
    Backend->>LLM (Gemini): model.generateContent(prompt)
    LLM (Gemini)-->>Backend: Return JSON { "trades": [{ "buy": "INTC", "amount": 1000 }] }
    
    Backend-->>Browser: Return Action Plan
    Browser-->>User: Show Modal: "Buy $1000 INTC to align with Thesis. Execute?"
