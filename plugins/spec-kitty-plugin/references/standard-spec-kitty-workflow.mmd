graph TD
    %% Nodes - Feature Level (Start)
    Start(("Start Feature<br><b style='color:#FF8C00'>/agent-orchestrator_plan</b>"))
    Specify["fa:fa-file-alt Specify Feature<br><b>/spec-kitty.specify</b>"]
    VerifySpec["fa:fa-shield-alt Verify Specify<br>(verify_workflow_state.py --phase specify)"]
    Plan["fa:fa-map Plan Implementation<br><b>/spec-kitty.plan</b>"]
    VerifyPlan["fa:fa-shield-alt Verify Plan<br>(verify_workflow_state.py --phase plan)"]
    Tasks["fa:fa-tasks Generate Tasks<br><b>/spec-kitty.tasks</b>"]
    VerifyTasks["fa:fa-shield-alt Verify Tasks<br>(verify_workflow_state.py --phase tasks)"]

    %% Nodes - WP Level (Loop)
    subgraph WP_Loop["WP Execution Loop (Repeated per WP)"]
        Implement["fa:fa-tools Start WP<br><b>spec-kitty implement WP-xx</b>"]
        VerifyImpl["fa:fa-shield-alt Verify Implement<br>(verify_workflow_state.py --phase implement)"]
        Code["fa:fa-code Code & Test<br>(Context: Inside Worktree)"]
        Commit["fa:fa-save Git Commit (Local)<br>(git commit -m 'feat...')"]
        VerifyReview["fa:fa-shield-alt Verify Review<br>(verify_workflow_state.py --phase review)<br>(Worktree clean?)"]
        MoveReview["fa:fa-arrow-right Move to Review<br>(CLI: spec-kitty agent tasks move-task)"]
        Review["fa:fa-glasses Review WP<br><b>/spec-kitty.review</b>"]
    end

    %% Nodes - Feature Level (End)
    subgraph Completion["Feature Completion"]
        VersionCheck["fa:fa-code-branch Version Check<br>(CLI: spec-kitty upgrade --dry-run)"]
        Accept["fa:fa-check-double Accept Feature<br><b>/spec-kitty.accept</b>"]
        StateBackup["fa:fa-save State Preservation<br>(Manual: Backup untracked state/caches)"]
        Merge["fa:fa-magic Spec-Kitty Merge<br><b>/spec-kitty.merge</b>"]
        End(("Feature Done<br>(Clean Repo)"))
    end

    %% Learning Loop (Protocol 128)
    subgraph LearningLoop["Learning Loop (Protocol 128)"]
        LL_Start["Outer Loop: Identify Knowledge Gap"]
        LL_Handoff["Bridge: Switch to Learning Mode"]
        LL_Execute["Inner Loop: Research & Codify"]
        LL_Return["Bridge: Return to Execution Mode"]
        LL_Start --> LL_Handoff --> LL_Execute --> LL_Return
    end

    %% Flow - Planning Phase
    Start --> Specify
    Specify --> VerifySpec
    VerifySpec --> Plan
    Plan --> VerifyPlan
    VerifyPlan --> Tasks
    Tasks --> VerifyTasks
    VerifyTasks --> Implement

    %% Loop Logic
    Implement --> VerifyImpl
    VerifyImpl -->|cd .worktrees/WP-xx| Code
    VerifyImpl -.->|Knowledge Gap?| LL_Start
    LL_Return -.-> Commit
    Code --> Commit
    Commit --> VerifyReview
    VerifyReview --> MoveReview
    MoveReview --> Review

    %% Iterate or Finish
    Review -->|Next WP?| Implement
    Review -->|All WPs Done?| Accept

    %% Finalization
    Accept --> VersionCheck
    VersionCheck --> StateBackup
    StateBackup --> Merge
    Merge --> End

    %% Styles
    classDef feature fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef wp fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    classDef done fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef verify fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px;
    classDef learning fill:#cc99ff,stroke:#333,stroke-width:2px;

    class Specify,Plan,Tasks feature;
    class Implement,Code,Commit,MoveReview,Review wp;
    class Accept,Merge,End,VersionCheck,StateBackup done;
    class VerifySpec,VerifyPlan,VerifyTasks,VerifyImpl,VerifyReview verify;
    class LL_Start,LL_Handoff,LL_Execute,LL_Return learning;
