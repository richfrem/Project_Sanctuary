---
config:
  theme: base
---
flowchart TB
 subgraph P1["Phase 1: Protocol Initialization"]
        Start(["ğŸš€ Start Analysis<br>Command: <b style='color:#1E90FF'>/legacy-system-oracle-forms_codify-form</b> [ID]"])
        InitCmd["<b style='color:#1E90FF'>/context-bundler_init</b> [ID] [TYPE]"]
        InitActions["Actions Performed:<br>1. Load base-[TYPE]-file-manifest.json<br>2. Query RLM Cache<br>3. Query dependency_map.json<br>4. Auto-add source & dep files<br>5. Write file-manifest.json<br>6. Execute /context-bundler_bundle"]
        Prohibition["â›” NEVER read rlm_summary_cache.json directly"]
  end
 subgraph P2["Phase 2: Context Review & Validation"]
        ReadBundle["view_file temp/context-bundles/ID_context.md"]
        CheckExisting@{ label: "Check: legacy-system/.../[ID]-Overview.md<br>(if exists, note what's already documented)" }
        ValidationChecklist{"Validation Checklist:<br>â˜ Source files (MD/XML) present?<br>â˜ Key dependencies listed?<br>â˜ RLM summaries included?<br>â˜ Template &amp; Policy in bundle?"}
        LoopGuard["Loop Counter: N (Max: 3)"]
  end
 subgraph P3["Phase 3: Discriminative Augmentation"]
        IdentifyGaps["Identify Missing Files:<br>- Specific source not in bundle<br>- Related form/lib overview<br>- DB package DDL"]
        EditManifest["<b style='color:#1E90FF'>/context-bundler_add</b> [PATH]<br>Add ONLY the identified missing files"]
        Regenerate["<b style='color:#1E90FF'>/context-bundler_bundle</b><br>(Regenerates bundle.py using file-manifest.json)"]
        IncrementN["N = N + 1"]
  end
 subgraph P4["Phase 4: Pre-Execution Contract"]
        PreCheck{"Contract Check:<br>â˜‘ Policy loaded?<br>â˜‘ Prompt loaded?<br>â˜‘ Template available?<br>â˜‘ Source context complete?"}
        ContractFail["âŒ Contract Failed<br>Log gaps, request human input"]
  end
 subgraph P5["Phase 5: Deep Dive Execution"]
        DeepDive["ğŸ¤– LLM Reasoning Phase<br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>1. <b style='color:#1E90FF'>/legacy-system-oracle-forms_investigate-form</b> [ID] (Mining)<br>2. <b style='color:#1E90FF'>/dependency-analysis_retrieve-dependency-graph</b> [ID] --deep<br>3. <b style='color:#1E90FF'>/legacy-system-oracle-forms_codify-form</b> [ID] (Orchestrate Analysis)<br>4. <b style='color:#1E90FF'>/legacy-system-database_investigate-code-search</b> (Logic Scan)<br>5. Register BRs: <b style='color:#1E90FF'>/legacy-system-business-rules_codify-business-rule</b>"]
        UpdateDocs["Create/Update Overview File<br>legacy-system/oracle-forms-overviews/.../ID-Overview.md"]
  end
 subgraph P6["Phase 6: Post-Processing Pipeline"]
        Enrich["<b style='color:#1E90FF'>/legacy-system-oracle-forms_curate-enrich-links</b> [DOC]"]
        Track["<b style='color:#1E90FF'>/legacy-system-oracle-forms_curate-audit-log</b> [ID]"]
        Distill["<b style='color:#1E90FF'>/rlm-factory_distill</b> [DOC]"]
        Ingest["<b style='color:#1E90FF'>/vector-db_ingest</b> [DOC]"]
        Master["<b style='color:#1E90FF'>/inventory-manager_curate-inventories</b>"]
  end
    Start --> InitCmd
    InitCmd --> InitActions
    InitActions -.- Prohibition
    InitActions --> ReadBundle
    ReadBundle --> CheckExisting
    CheckExisting --> ValidationChecklist
    ValidationChecklist -- âŒ Gaps Found --> LoopGuard
    LoopGuard -- N &lt; 3 --> IdentifyGaps
    LoopGuard -- "N >= 3" --> ContractFail
    IdentifyGaps --> EditManifest
    EditManifest --> Regenerate
    Regenerate --> IncrementN
    IncrementN -- recursion to</br>add all key</br>details to manifest --> ReadBundle
    ValidationChecklist -- âœ… Complete --> PreCheck
    PreCheck -- âœ… Pass --> DeepDive
    PreCheck -- âŒ Fail --> ContractFail
    DeepDive --> UpdateDocs
    UpdateDocs --> Enrich
    Enrich --> Track
    Track --> Distill
    Distill --> Ingest
    Ingest --> Master
    Master --> Complete(["âœ… Analysis Complete"])
    ContractFail --> Complete

    CheckExisting@{ shape: rect}
    style Start fill:#90EE90
    style ValidationChecklist fill:#FFD700
    style PreCheck fill:#FFD700
    style ContractFail fill:#FFB6C1
    style DeepDive fill:#E6E6FA
    style Complete fill:#90EE90