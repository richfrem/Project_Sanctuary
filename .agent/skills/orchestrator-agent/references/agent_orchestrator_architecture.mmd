flowchart TD
    %% ----------------------------------------------------
    %% Agent Orchestrator: Hierarchical Handoff Pattern
    %% ----------------------------------------------------

    classDef outer fill:#99ccff,stroke:#333,stroke-width:2px;
    classDef inner fill:#cc99ff,stroke:#333,stroke-width:2px;
    classDef storage fill:#ffff99,stroke:#333,stroke-width:2px;

    %% Phase 1: Plan
    subgraph Planning ["1. Outer Loop: Strategy Phase"]
        direction TB
        CmdPlan["/agent-orchestrator_plan"]:::outer
        Spec["/spec-kitty.specify<br>(spec.md)"]:::outer --> PlanDoc["/spec-kitty.plan<br>(plan.md)"]:::outer
        PlanDoc --> Tasks["/spec-kitty.tasks<br>(tasks.md)"]:::outer
        CmdPlan --> Spec
    end

    %% Phase 2: Delegate
    subgraph Delegation ["2. Outer Loop: Delegation"]
        direction TB
        Tasks --> Implement["spec-kitty implement WP-NN"]:::outer
        Implement --> PacketGen["/agent-orchestrator_delegate"]:::outer
        PacketGen --> Packet[".agent/handoffs/<br>task_packet_NN.md"]:::storage
    end

    %% Phase 3: Execute
    subgraph Execution ["3. Inner Loop: Execution"]
        direction TB
        Packet --> InnerAgent[Inner Agent / Worker]:::inner
        InnerAgent --> Code[Write Code & Run Tests]:::inner
        Code --> VerifyRequest[Signal Completion]:::inner
    end

    %% Phase 4: Verify
    subgraph Verification ["4. Outer Loop: Verification"]
        direction TB
        VerifyRequest --> Verify["/agent-orchestrator_verify"]:::outer
        Verify --> Decision{Pass?}:::outer
        
        Decision -- No --> Correct["/agent-orchestrator_verify<br>--feedback"]:::outer
        Correct --> CorrectionPacket[".agent/handoffs/<br>correction_packet_NN.md"]:::storage
        CorrectionPacket --> InnerAgent
        
        Decision -- Yes --> Review["/agent-orchestrator_review"]:::outer
    end

    %% Phase 5: Closure
    subgraph Closure ["5. Outer Loop: Closure"]
        direction TB
        Review --> Retro["/agent-orchestrator_retro"]:::outer
        Retro --> Merge["/spec-kitty.merge"]:::outer
        Merge --> Done([Done]):::outer
    end
