# Python Dependency Management Guide
**(Based on ADR 073)**

## 1. Core Principles
1.  **Locked Files**: We never use manual `pip install`. We only install from locked `requirements.txt` files.
2.  **Intent vs. Truth**:
    -   `*.in` files = **Human Intent** (what you edit).
    -   `*.txt` files = **Machine Truth** (generated by `pip-compile`).
3.  **One World**: Docker containers and local environments share the same lockfiles.

## 2. How to Add a Dependency

### Step 1: Identify the Correct `.in` File
| Scope | File Path |
|-------|-----------|
| **Core** (Shared Libs) | `mcp_servers/gateway/requirements-core.in` |
| **Service** (e.g., Cortex) | `mcp_servers/gateway/clusters/sanctuary_cortex/requirements.in` |
| **Dev Tools** (Local Only) | `requirements-dev.in` |

### Step 2: Edit Intent
Add the package name to the `.in` file.
```text
# mcp_servers/gateway/requirements-core.in
fastapi>=0.110.0
langchain
```

### Step 3: Compile (Generate Lock)
Run `pip-compile` to generate the `.txt` file.
```bash
# Example for Core
pip-compile mcp_servers/gateway/requirements-core.in --output-file mcp_servers/gateway/requirements-core.txt

# Example for Cortex
pip-compile mcp_servers/gateway/clusters/sanctuary_cortex/requirements.in --output-file mcp_servers/gateway/clusters/sanctuary_cortex/requirements.txt
```

### Step 4: Install
**Locally:**
```bash
pip install -r mcp_servers/gateway/requirements-core.txt
```
**Container:**
```bash
# Rebuild the specific service
make up force=true TARGET=sanctuary_cortex
```

## 3. How to Update Dependencies
(e.g., Security Fixes or Dependabot)

**DO NOT EDIT .txt FILES MANUALLY.**

To upgrade a package:
```bash
pip-compile --upgrade-package uvicorn mcp_servers/gateway/requirements-core.in
```

To upgrade everything:
```bash
pip-compile --upgrade mcp_servers/gateway/requirements-core.in
```
