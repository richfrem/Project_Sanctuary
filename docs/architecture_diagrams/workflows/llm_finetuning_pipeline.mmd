%% Name: LLM Fine-Tuning Pipeline (Phoenix Forge)
%% Description: End-to-end QLoRA fine-tuning: Setup → Data Forging → Training → GGUF Conversion → Deployment
%% Location: docs/architecture_diagrams/workflows/llm_finetuning_pipeline.mmd

graph TD
    subgraph "Phase 0: One-Time System Setup"
        P0A["WSL2 & NVIDIA Drivers<br/>*Host Environment*"]
        P0B["Build llama.cpp<br/>*Sibling Repo*"]
        P0C["Hugging Face Auth<br/>*.env token*"]
    end

    subgraph "Phase 1: Environment Verification"
        A["setup_cuda_env.py<br/>*Creates ~/ml_env*"]
        A_out(" ml_env venv")
        A1["Verify Environment<br/>*verify_environment.sh*"]
        A1_out(" Environment Validated")
    end

    subgraph "Phase 2: Dataset Forging & Model Download"
        B["download_model.sh<br/>*Qwen2-7B-Instruct*"]
        B_out(" Base Model")
        C["forge_whole_genome_dataset.py<br/>*Data Harvester*"]
        C_out(" sanctuary_whole_genome_data.jsonl")
        D["validate_dataset.py<br/>*JSONL Verification*"]
        D_out(" Validated Dataset")
    end

    subgraph "Phase 3: Fine-Tuning (QLoRA)"
        E["fine_tune.py<br/>*Timer & Resume Enabled*"]
        E_out(" LoRA Adapter")
    end

    subgraph "Phase 4: Merge & GGUF Conversion"
        F["merge_adapter.py<br/>*8GB VRAM Safe Merge*"]
        F_out(" Merged Model (models/merged/)*")
        G["convert_to_gguf.py<br/>*Quantize to Q4_K_M*"]
        G_out(" GGUF Model")
    end

    subgraph "Phase 5: Ollama Deployment"
        H["create_modelfile.py<br/>*Generates Modelfile*"]
        H_out(" Ollama Modelfile")
        I["ollama create/run<br/>*Local Deployment*"]
        I_out(" GUARDIAN-01 Active")
    end

    subgraph "Phase 6: Hugging Face Upload (Optional)"
        L["upload_to_huggingface.py<br/>*Upload GGUF/Adapter*"]
        L_out(" Models on HF Hub")
    end

    %% Workflow Connections
    P0A --> P0B;
    P0B --> P0C;
    P0C --> A;
    A --> A_out;
    A_out --> A1;
    A1 --> A1_out;
    A1_out --> B;
    A1_out --> C;
    C --> C_out;
    C_out --> D;
    B --> B_out;
    B_out & D -- Input --> E;
    E --> E_out;
    B_out & E_out -- Input --> F;
    F --> F_out;
    F_out --> G;
    G --> G_out;
    G_out --> H;
    H --> H_out;
    H_out --> I;
    I --> I_out;
    G_out --> L;
    L --> L_out;

    %% Styling
    classDef script fill:#e8f5e8,stroke:#333,stroke-width:2px;
    classDef artifact fill:#e1f5fe,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5;
    
    class P0A,P0B,P0C,A,A1,B,C,D,E,F,G,H,I,L script;
    class A_out,A1_out,B_out,C_out,D_out,E_out,F_out,G_out,H_out,I_out,L_out artifact;
