graph TD
    subgraph "Phase I: Mutation (Stochastic Policy Search)"
        Base[System Prompt T0] -->|LLM Mutates| Candidate[Candidate Policy T1]
        style Base fill:#e1f5fe,stroke:#01579b
        style Candidate fill:#fff9c4,stroke:#fbc02d
    end

    subgraph "Phase II: Selection (Objective Functions)"
        Candidate -->|Input| Validator{Scripted Validator}
        
        Validator -->|Fail: Schema/Syntax| Discard[Discard & Log]
        Validator -->|Pass| MetricCheck{Metric Gate}
        
        MetricCheck -->|Fail: QD-Score < Threshold| Discard
        MetricCheck -->|Pass| RedTeam{Human Red Team}
        
        RedTeam -->|Reject| AdversaryStore[Update edge_case_registry.json]
        AdversaryStore -.->|Regression Test| Validator
        
        RedTeam -->|Approve| Elite[Sealed Policy T1]
        style Elite fill:#c8e6c9,stroke:#2e7d32
    end

    subgraph "Phase III: Retention (Map-Elites)"
        Elite -->|Compute Metrics| Archive[Map-Elites Grid]
        Archive -->|Axis: citation_density| Cell1[Deep Technical]
        Archive -->|Axis: domain_span| Cell2[Broad System]
    end

    subgraph "Implementation Layer"
        Validator -.->|Executes| Script1[scripts/evaluator_preflight.py]
        AdversaryStore -.->|Writes| File1[.agent/learning/edge_case_registry.json]
        Elite -.->|Executes| CLI1[cortex_cli.py snapshot --seal]
    end

    Discard -->|Retry| Base
    style Validator fill:#ffccbc,stroke:#bf360c
    style Script1 fill:#eeeeee,stroke:#9e9e9e,stroke-dasharray: 5 5
    style File1 fill:#eeeeee,stroke:#9e9e9e,stroke-dasharray: 5 5
    style CLI1 fill:#eeeeee,stroke:#9e9e9e,stroke-dasharray: 5 5
