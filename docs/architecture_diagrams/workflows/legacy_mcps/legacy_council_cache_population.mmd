---
config:
  theme: base
---
%% Name: Legacy Council Cache Population
%% Source: docs/legacy/council_orchestrator/README_GUARDIAN_WAKEUP.md
%% Location: docs/architecture_diagrams/workflows/legacy_council_cache_population.mmd
%% Description: Legacy process for pre-filling the Guardian cache within the Council Orchestrator

sequenceDiagram
    autonumber

    participant U as User/System

    box "orchestrator/app.py" #FFFFF8
        participant O as Orchestrator
    end
    box "orchestrator/memory/cortex.py" #FFFFF8
        participant CM as CortexManager
    end
    box "orchestrator/memory/cache.py" #FFFFF8
        participant CacheMgr as CacheManager
    end
    box "mnemonic_cortex/chroma_db/" #FFFFF8
        participant RAG as RAG DB (ChromaDB)
    end
    box "council_orchestrator/mnemonic_cortex/cache/" #FFFFF8
        participant CacheFS as Filesystem Cache
    end

    U->>O: Starts `orchestrator.main`
    O->>O: Orchestrator.__init__() is called
    Note right of O: `self.cortex_manager = CortexManager(...)` is created
    O->>CM: **Invoke `prefill_guardian_start_pack()`**
    Note over CM, RAG: Queries RAG DB for latest documents...
    CM->>CacheMgr: `cache_manager.query_cortex("latest chronicles", limit=15)`
    CacheMgr->>RAG: Executes similarity search
    RAG-->>CacheMgr: Returns document data
    Note right of CacheMgr: Data for 'chronicles' received
    CacheMgr->>CacheFS: `_write_bundle_to_cache('chronicles', data)`
    CacheFS-->>CacheMgr: Writes `chronicles_bundle.json`
    CM->>CacheMgr: `cache_manager.query_cortex("latest protocols", limit=15)`
    CacheMgr->>RAG: Executes similarity search
    RAG-->>CacheMgr: Returns document data
    Note right of CacheMgr: Data for 'protocols' received
    CacheMgr->>CacheFS: `_write_bundle_to_cache('protocols', data)`
    CacheFS-->>CacheMgr: Writes `protocols_bundle.json`
    Note over O: Orchestrator signals completion
    O-->>U: Displays console log: "[CACHE] Pre-fill complete. Cache is warm."
    O-->>U: Displays console log: "--- Orchestrator Idle. ---"
