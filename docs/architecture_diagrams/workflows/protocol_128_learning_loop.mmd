---
config:
  layout: dagre
  theme: base
---

%% Name: Protocol 128: Learning Loop (v2.0 - with RLM Synthesis)
%% Description: Cognitive Continuity workflow: Scout → Synthesize → Audit → RLM Synthesis → Seal → Soul Persist
%% Location: docs/architecture_diagrams/workflows/protocol_128_learning_loop.mmd

flowchart TB
    subgraph subGraphScout["I. The Learning Scout"]
        direction TB
        Start["Session Start"] --> Wakeup["cortex_guardian_wakeup"]
        Wakeup --> ReadSnapshot["Read: learning_package_snapshot.md<br>(The Cognitive Hologram)"]
    end

    subgraph subGraphSynthesize["II. Intelligence Synthesis"]
        direction TB
        Work["Active Work / Coding"] --> ADRs["Record ADRs"]
    end

    subgraph subGraphAudit["IV. Red Team Audit"]
        direction TB
        AuditPacket["Generate Learning Audit Packet"] --> RedTeam{"Red Team<br>Approve?"}
    end

    subgraph subGraphRLM["V. RLM (Recursive Language Model) Context Synthesis (Protocol 132)"]
        direction TB
        TriggerRLM["Trigger: RLM Synthesizer"]
        Map["Map: Protocols, ADRs, Code"]
        Reduce["Reduce: Generate Holistic Summary"]
        WriteSnapshot["Write: learning_package_snapshot.md"]
        
        TriggerRLM --> Map --> Reduce --> WriteSnapshot
    end

    subgraph subGraphSeal["VI. The Technical Seal"]
        direction TB
        RLMTrigger["Trigger Protocol 132 (RLM)"]
        SealCmd["cortex_capture_snapshot --type seal"]
        SealCmd --> RLMTrigger
    end

    subgraph subGraphPersist["VII. Soul Persistence"]
        direction TB
        Persist["cortex-persist-soul"]
    end

    %% Flow
    ReadSnapshot --> Work
    Work --> AuditPacket
    RedTeam -- "YES" --> TriggerRLM
    RedTeam -- "NO" --> Work
    WriteSnapshot --> Seal
    Seal --> Persist
    Persist --> End["End Session"]

    style subGraphRLM fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    style subGraphSeal fill:#fff3e0,stroke:#e65100,stroke-width:2px