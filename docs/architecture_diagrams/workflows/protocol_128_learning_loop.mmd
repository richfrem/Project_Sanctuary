---
config:
  layout: dagre
  theme: base
---

%% Name: Protocol 128: Learning Loop (v3.0 - with RLM Synthesis)
%% Description: 10-phase Cognitive Continuity workflow for agent session management
%% Workflow: .agent/workflows/workflow-learning-loop.md (human-readable steps)
%% Location: docs/architecture_diagrams/workflows/protocol_128_learning_loop.mmd
%% Phases: Scout → Synthesize → Strategic Gate → Audit → RLM → Seal → Persist → Self-Correct → Ingest → Forge


flowchart TB
    subgraph subGraphScout["I. The Learning Scout (MANDATORY)"]
        direction TB
        Start["Session Start<br>(/workflow-start + /speckit-specify)"] --> AccessMode{"Access Mode?"}
        
        %% Context Note
        ContextNote["ℹ️ Context: Executed within Standard Hybrid Workflow<br>(See hybrid-spec-workflow.mmd)"] -.-> Start
        
        AccessMode -- "IDE Mode<br>(File + CLI)" --> IDE_Primer["Read File: .agent/learning/cognitive_primer.md"]
        AccessMode -- "MCP Only<br>(API/Web)" --> MCP_Wakeup["Tool: cortex_guardian_wakeup<br>(Returns Primer + HMAC Check)"]
        
        IDE_Primer --> IDE_Wakeup["CLI/Tool: cortex_guardian_wakeup<br>(Iron Check + HMAC)"]
        IDE_Wakeup --> IronCheckGate1{Iron Check?}
        
        IronCheckGate1 -- PASS --> IDE_Debrief["Workflow: /workflow-scout<br>(Calls cortex debrief)"]
        IronCheckGate1 -- FAIL --> SafeMode1[SAFE MODE<br>Read-Only / Halt]
        
        MCP_Wakeup --> IronCheckGate1
        MCP_Debrief["Tool: cortex_learning_debrief<br>(Returns Full Context)"]
        
        IDE_Debrief --> SeekTruth["Context Acquired"]
        MCP_Wakeup --> MCP_Debrief --> SeekTruth
        
        SuccessorSnapshot["File: .agent/learning/learning_package_snapshot.md<br>(Truth Anchor / Cognitive Hologram)"] -.->|Embedded in Debrief| SeekTruth
    end

    subgraph subGraphSynthesize["II. Intelligence Synthesis"]
        direction TB
        
        SynthesisDecision{"Mode?"}
        
        subgraph EvoLoop["Evolutionary Branch (v4.0)"]
            direction TB
            Mutate["Mutate Policy (DRQ)"] --> PreFlight{"Pre-Flight<br>(Auto-Gate)"}
            PreFlight -- FAIL --> Mutate
            PreFlight -- PASS --> AdversaryGate{"Adversary<br>Gate"}
            AdversaryGate -- FAIL --> Mutate
            AdversaryGate -- PASS --> MapElites["Map-Elites Archive"]
        end
        
        Intelligence["AI: Autonomous Synthesis"] --> SynthesisDecision
        SynthesisDecision -- Standard --> Synthesis["Action: Record ADRs / Protocols<br>(Update Manifest)"]
        SynthesisDecision -- Evolutionary --> Mutate
        
        MapElites --> Synthesis
    end

    subgraph subGraphStrategic["III. Strategic Review (Gate 1)"]
        direction TB
        GovApproval{"Strategic Approval<br>(HITL Required)"}
    end

    subgraph subGraphAudit["IV. Red Team Audit Loop"]
        direction TB
        AgreeTopic["1. Agree on Research Topic<br>with User"] --> CreateFolder["2. Create LEARNING/topics/[topic]/"]
        CreateFolder --> CaptureResearch["3. Capture Research in Topic Folder<br>(analysis.md, questions.md, sources.md)"]
        CaptureResearch --> UpdateManifest["4. Update manifest<br>(.agent/learning/learning_audit/learning_audit_manifest.json)"]
        UpdateManifest --> UpdatePrompt["5. UPDATE prompts<br>(.agent/learning/learning_audit/learning_audit_prompts.md)"]
        UpdatePrompt --> GenerateSnapshot["6. Workflow: /workflow-audit<br>(Protocol 130 Dedupe)"]
        GenerateSnapshot --> SharePacket["7. Output Path:<br>.agent/learning/learning_audit/learning_audit_packet.md"]
        SharePacket --> ReceiveFeedback{"8. Red Team Feedback"}
        ReceiveFeedback -- "More Research" --> CaptureFeedback["Capture Feedback in Topic Folder"]
        CaptureFeedback --> CaptureResearch
        ReceiveFeedback -- "Ready" --> TechApproval{"Gate 2: HITL"}
    end

    subgraph subGraphRLM["V. RLM Context Synthesis (Protocol 132)"]
        direction TB
        TriggerRLM["Trigger: RLM Synthesizer<br>(Local Sovereign LLM)"]
        Map["Map: Read Protocols, ADRs, Code<br>(learning_manifest.json)"]
        Reduce["Reduce: Generate Holistic Summary<br>(1-sentence per file)"]
        WriteHologram["Write: learning_package_snapshot.md<br>(The Cognitive Hologram)"]
        
        TriggerRLM --> Map --> Reduce --> WriteHologram
    end
    style subGraphRLM fill:#e1f5fe,stroke:#01579b,stroke-width:2px

    subgraph subGraphSeal["VI. The Technical Seal"]
        direction TB
        CaptureSeal["Workflow: /workflow-seal<br>(Triggers RLM + Iron Check)"] --> SealCheck{Iron Check?}
        SealCheck -- FAIL --> SafeMode2[SAFE MODE<br>Seal Blocked]
        SealCheck -- PASS --> SealSuccess[Seal Applied]
    end
    style subGraphSeal fill:#fff3e0,stroke:#e65100,stroke-width:2px

    subgraph subGraphPersist["VII. Soul Persistence (ADR 079 / 081)"]
        direction TB
        choice{Persistence Type}
        choice -- Incremental --> Inc["Workflow: /workflow-persist<br>(Append 1 Record)"]
        choice -- Full Sync --> Full["Workflow: /workflow-persist (Full)<br>(Regenerate ~1200 records)"]
        
        subgraph HF_Repo["HuggingFace: Project_Sanctuary_Soul"]
            MD_Seal["lineage/{MODEL}_seal_{TIMESTAMP}.md"]
            JSONL_Traces["data/soul_traces.jsonl"]
            Manifest["metadata/manifest.json"]
        end
    end
    style subGraphPersist fill:#cce5ff,stroke:#004085,stroke-width:2px

    subgraph PhaseVIII [Phase VIII: Self-Correction]
        direction TB
        Deployment[Deploy & Policy Update]
        Retro["Loop Retrospective<br>Workflow: /workflow-retrospective<br>(Singleton)"]
        ShareRetro["Share with Red Team<br>(Meta-Audit)"]
    end
    style PhaseVIII fill:#d4edda,stroke:#155724,stroke-width:2px

    subgraph PhaseIX [Phase IX: Relational Ingestion & Closure]
        direction TB
        Ingest["Workflow: /workflow-ingest<br>(Update RAG Vector DB)"]
        GitOps["Git: add . && commit && push<br>(Sync to Remote)"]
        End["Workflow: /workflow-end"]
        Ingest --> GitOps
        GitOps --> End
    end
    style PhaseIX fill:#fff3cd,stroke:#856404,stroke-width:2px

    subgraph PhaseX [Phase X: Phoenix Forge]
        direction TB
        ForgeDataset["Scripts: forge_whole_genome_dataset.py<br>(Sync Soul Traces to Training Data)"]
        FineTune["Scripts: fine_tune.py<br>(QLoRA Training)"]
        GGUFConvert["Scripts: convert_to_gguf.py<br>(Quantize & Quant)"]
        HFDeploy["Tool: upload_to_huggingface.py<br>(Deploy Model to Hub)"]
    end
    style PhaseX fill:#f8d7da,stroke:#721c24,stroke-width:2px

    %% Flow - Phase Connections
    SeekTruth -- "Carry Context" --> Intelligence
    Synthesis -- "Verify Reasoning" --> GovApproval
    
    GovApproval -- "PASS" --> AgreeTopic
    
    %% ============================================================
    %% CRITICAL: Protocol 128 Closure Sequence (MUST BE THIS ORDER)
    %% Audit → RLM → Seal → Persist → Retro → Ingest → End
    %% ============================================================
    
    %% Phase IV → V: Audit passes to RLM
    TechApproval -- "PASS" --> TriggerRLM
    
    %% Phase V → VI: RLM writes hologram, Seal validates
    WriteHologram --> CaptureSeal
    SealSuccess -- "Step 1: Sealed" --> choice
    
    %% Phase VII → VIII: Persist then Retro
    Inc --> JSONL_Traces
    Inc --> MD_Seal
    Full --> JSONL_Traces
    Full --> Manifest
    
    JSONL_Traces -- "Step 2: Persisted" --> Deployment
    Deployment --> Retro
    Retro -- "Step 3: Retrospective Complete" --> ShareRetro
    
    %% Phase VIII → IX: Retro to Ingest/End
    ShareRetro --> Ingest
    
    %% Phoenix Forge Branch (Optional)
    JSONL_Traces -- "Training Fuel" --> ForgeGate{HITL:<br>Time to<br>Forge?}
    ForgeGate -- "YES (Slow)" --> ForgeDataset
    ForgeGate -- "NO" --> Ingest
    ForgeDataset --> FineTune
    FineTune --> GGUFConvert
    GGUFConvert --> HFDeploy
    
    Ingest -- "Cycle Complete" --> Start
    HFDeploy -- "Cognitive Milestone" --> Retro
    
    %% Backtrack paths (failures return to Retro for correction)
    GovApproval -- "FAIL: Backtrack" --> Retro
    TechApproval -- "FAIL: Backtrack" --> Retro
    SealCheck -- "FAIL: Backtrack" --> Retro
    
    GitOps -- "Recursive Learning" --> Start

    style IDE_Wakeup fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:black
    style MCP_Wakeup fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:black
    style SuccessorSnapshot fill:#f9f,stroke:#333,stroke-width:2px,color:black
    style Start fill:#dfd,stroke:#333,stroke-width:2px,color:black
    style SafeMode1 fill:#ffcccb,stroke:#b30000,stroke-width:4px,color:black
    style SafeMode2 fill:#ffcccb,stroke:#b30000,stroke-width:4px,color:black
    style TriggerRLM fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:black

    %% Metadata
    style EvoLoop fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,stroke-dasharray: 5 5