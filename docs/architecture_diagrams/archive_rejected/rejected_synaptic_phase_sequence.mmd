sequenceDiagram
    autonumber
    actor User
    participant CLI as Cortex CLI (Client)
    participant Cortex as Container: sanctuary_cortex<br/>(Service #5)
    participant Ollama as Container: sanctuary_ollama<br/>(Service #3)
    participant Mailbox as File: /app/data/cortex.json<br/>(Host: ./data/cortex.json)

    Note over User, CLI: Phase V: The Technical Seal
    User->>CLI: snapshot --seal
    CLI->>Cortex: POST /tools/call (Result: cortex_dream)
    Cortex-->>CLI: 202 Accepted (Immediately)
    CLI->>User: "Session Sealed. Dreaming in background."
    Note right of CLI: CLI/User Session Ends Here

    rect rgb(240, 248, 255)
        Note over Cortex, Mailbox: Phase V-B: Synaptic Phase (Async)
        Cortex->>Cortex: Dreamer.initialize()<br/>(Load Prompts & Epistemic Anchors)
        Cortex->>Mailbox: Read "chronicle.jsonl" (24h Window)
        
        loop Orchestration Loop (Per Log Chunk)
            note right of Cortex: 1. Construct Context
            Cortex->>Cortex: Format Prompt
            
            note right of Cortex: 2. Dispatch to LLM
            Cortex->>Ollama: POST /api/generate<br/>{ "model": "qwen2", "prompt": "...", "stream": false }
            
            note right of Ollama: 3. Inference (Blocking)
            Ollama->>Ollama: "Thinking..." (GPU)
            Ollama-->>Cortex: 200 OK<br/>{ "response": "{ \"opinions\": [...] }" }
            
            note right of Cortex: 4. Validation & Logic
            Cortex->>Cortex: Parse JSON
            Cortex->>Cortex: Validate against Iron Core<br/>(Epistemic Check)
        end

        note right of Cortex: 5. Persistence
        Cortex->>Mailbox: Write "cortex.json"<br/>(Merge with existing beliefs)
        Note right of Mailbox: Next Session Will Read This
    end
