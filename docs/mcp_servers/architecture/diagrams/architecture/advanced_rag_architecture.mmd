---
config:
  theme: base
  layout: dagre
---
flowchart TB
 subgraph IP["Ingestion Pipeline (IP)"]
    direction TB
        Setup["IP1: Cortex MCP<br/>cortex_ingest_full()"]
        ParentStore[("Parent Doc Store<br/>(ChromaDB Collection)<br/>parent_documents")]
        VDB_Child[("Vector DB<br/>(Child Chunks)<br/>ChromaDB")]
  end
 subgraph QP["Query Pipeline (QP) - MCP-Enabled"]
    direction TB
        UserQuery["User Query<br/>Natural Language or Protocol 87"]
        
        subgraph Cortex["Cortex MCP (Orchestrator)"]
            QueryParser["QP1: Query Parser<br/>Protocol 87 or NL"]
            Cache{"QP3: Mnemonic Cache<br/>(CAG)<br/>Phase 3"}
            Router["QP4b: MCP Router<br/>Scope-based Routing"]
        end
        
        CachedAnswer["QP4a: Cached Answer<br/>(Cache Hit)"]
        
        subgraph MCPs["MCP Ecosystem (Specialized Servers)"]
            ProtocolMCP["Protocol MCP Server<br/>protocol_get()"]
            ChronicleMCP["Chronicle MCP Server<br/>chronicle_get_entry()"]
            TaskMCP["Task MCP Server<br/>get_task()"]
            CodeMCP["Code MCP Server<br/>code_search_content()"]
            ADRMCP["ADR MCP Server<br/>adr_get()"]
            
            subgraph VectorFallback["Vector DB Fallback"]
                PDR{"Parent Document<br/>Retriever<br/>cortex_query()"}
            end
        end
        
        subgraph DataStores["Data Stores"]
            ProtocolFiles[("01_PROTOCOLS/<br/>Markdown Files")]
            ChronicleFiles[("00_CHRONICLE/<br/>Markdown Files")]
            TaskFiles[("TASKS/<br/>Markdown Files")]
            CodeFiles[("Source Code<br/>Python/JS/etc")]
            ADRFiles[("ADRs/<br/>Markdown Files")]
        end
        
        RetrievedContext["QP8: Retrieved Context<br/>(Complete Documents)"]
        LLMPrompt["QP9: LLM Prompt"]
        LLM["QP10: LLM<br/>(Ollama Sanctuary-Qwen2-7B:latest)"]
        NewAnswer["QP10: Newly Generated<br/>Answer"]
  end
    
    Setup -- IP2: Stores Parent Docs --> ParentStore
    Setup -- IP3: Stores Child Chunks --> VDB_Child
    
    UserQuery --> QueryParser
    QueryParser -- QP2: Parse --> Cache
    Cache -- Cache Hit --> CachedAnswer
    Cache -- Cache Miss --> Router
    
    Router -- "SCOPE: Protocols" --> ProtocolMCP
    Router -- "SCOPE: Living_Chronicle" --> ChronicleMCP
    Router -- "SCOPE: Tasks" --> TaskMCP
    Router -- "SCOPE: Code" --> CodeMCP
    Router -- "SCOPE: ADRs" --> ADRMCP
    Router -- "SCOPE: mnemonic_cortex<br/>(Fallback)" --> PDR
    
    ProtocolMCP --> ProtocolFiles
    ChronicleMCP --> ChronicleFiles
    TaskMCP --> TaskFiles
    CodeMCP --> CodeFiles
    ADRMCP --> ADRFiles
    
    PDR -- QP5: Queries Chunks --> VDB_Child
    VDB_Child -- QP6: Returns CHUNK IDs --> PDR
    PDR -- QP7: Queries Parents --> ParentStore
    ParentStore -- QP8: Returns FULL Docs --> PDR
    
    ProtocolMCP --> RetrievedContext
    ChronicleMCP --> RetrievedContext
    TaskMCP --> RetrievedContext
    CodeMCP --> RetrievedContext
    ADRMCP --> RetrievedContext
    PDR --> RetrievedContext
    
    UserQuery --> LLMPrompt
    RetrievedContext --> LLMPrompt
    LLMPrompt --> LLM
    LLM --> NewAnswer
    NewAnswer -- QP11: Store in Cache --> Cache
    
    CachedAnswer --> FinalOutput(["QP12: Response"])
    NewAnswer --> FinalOutput