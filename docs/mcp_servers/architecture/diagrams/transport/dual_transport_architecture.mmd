---
config:
  theme: base
  layout: dagre
---
flowchart TB
 subgraph subGraph0["Local Workstation (Client & Test Context)"]
        direction TB
        Claude["Claude Desktop<br/>(Bridged Session)"]
        VSCode["VS Code Agent<br/>(Direct Attempt)"]
        Bridge@{ label: "MCP Gateway Bridge<br/>'bridge.py'" }
        
        subgraph subGraphTest["Testing Suite"]
            E2E_Test{{E2E Tests}}
            Int_Test{{Integration Tests}}
        end
  end

 subgraph subGraph1["server.py (Entry Point)"]
        Selector{"MCP_TRANSPORT<br/>Selector"}
        StdioWrap@{ label: "FastMCP Wrapper<br/>'stdio'" }
        SSEWrap@{ label: "SSEServer Wrapper<br/>'sse'" }
  end

 subgraph subGraph2["Core Logic Layers"]
        Ops@{ label: "Operations Layer<br/>'operations.py'" }
        Models@{ label: "Data Models<br/>'models.py'" }
  end

 subgraph subGraph3["MCP Cluster Container"]
    direction TB
        subGraph1
        subGraph2
  end

 subgraph subGraph4["Podman Network (Fleet Context)"]
        Gateway@{ label: "IBM ContextForge Gateway<br/>'mcpgateway:4444'" }
        subGraph3
  end

    %% COMPLIANT PATH (Claude / Production)
    Claude -- "Stdio" --> Bridge
    Bridge -- "HTTP / JSON-RPC 2.0<br/>(Token Injected)" --> Gateway
    E2E_Test -- "Simulates Stdio" --> Bridge

    %% NON-COMPLIANT SHORTCUT (The 'Efficiency Trap')
    VSCode -. "Direct RPC / SSE<br/>(Handshake Mismatch)" .-> Gateway

    %% EXECUTION FLOW
    Gateway -- "SSE Handshake<br/>(endpoint event)" --> SSEWrap
    SSEWrap -- "Execute" --> subGraph2

    %% Integration / Developer Flow
    IDE["Terminal / IDE"] -- "Direct Stdio Call" --> StdioWrap
    Int_Test -- "Validates Schemas" --> subGraph1
    StdioWrap -- "Execute" --> subGraph2

    %% Logic Selection
    Selector -- "If 'stdio'" --> StdioWrap
    Selector -- "If 'sse'" --> SSEWrap

    style Bridge fill:#f9f,stroke:#333,stroke-width:2px
    style VSCode fill:#fdd,stroke:#f66,stroke-width:2px,stroke-dasharray: 5 5
    style Gateway fill:#69f,stroke:#333,stroke-width:2px
    style Selector fill:#fff,stroke:#333,stroke-dasharray: 5 5