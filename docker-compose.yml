services:
  vector_db:
    image: chromadb/chroma:latest
    container_name: sanctuary_vector_db
    ports:
      - "8110:8000"
    volumes:
      # Chroma writes to /data by default in current image version
      - ${CHROMA_DATA_PATH:-.vector_data}:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - PERSIST_DIRECTORY=/chroma/chroma
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    restart: unless-stopped
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp_network

  ollama_model_mcp:
    image: ollama/ollama:latest
    container_name: sanctuary_ollama_mcp
    ports:
      - "11434:11434"
    volumes:
      # Mount point for models persisted on the host machine
      - ./ollama_models:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0 # Use OLLAMA_MODEL from the host environment if available, otherwise default
      - OLLAMA_MODEL=${OLLAMA_MODEL:-hf.co/richfrem/Sanctuary-Qwen2-7B-v1.0-GGUF-Final:Q4_K_M}
    networks:
      - mcp_network
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        ollama serve &
        # Wait for Ollama to be ready
        echo "Waiting for Ollama API..."
        until ollama list > /dev/null 2>&1; do
          sleep 1
        done
        echo "Ollama is ready. Pulling model..."
        ollama pull $${OLLAMA_MODEL:-Sanctuary-Qwen2-7B:latest}
        wait
    restart: unless-stopped

  # Fleet of 8 - Container #1: sanctuary_utils (ADR 060)
  sanctuary_utils:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_utils/Dockerfile
    container_name: sanctuary_utils
    ports:
      - "8100:8000"
    volumes:
      - .:/app
    networks:
      - mcp_network
    environment:
      - PORT=8000
      - MCP_TRANSPORT=sse
      - PYTHONPATH=/app
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_utils.server" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/sse" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # Fleet of 8 - Container #2: sanctuary_filesystem (Task 128)
  sanctuary_filesystem:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_filesystem/Dockerfile
    container_name: sanctuary_filesystem
    ports:
      - "8101:8000"
    volumes:
      - .:/app
    networks:
      - mcp_network
    environment:
      - PORT=8000
      - MCP_TRANSPORT=sse
      - PROJECT_ROOT=/app
      - PYTHONUNBUFFERED=1
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_filesystem.server" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/sse" ]
      interval: 30s
      retries: 3
    restart: unless-stopped

  # Fleet of 8 - Container #3: sanctuary_network (Task 129)
  sanctuary_network:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_network/Dockerfile
    container_name: sanctuary_network
    ports:
      - "8102:8000"
    volumes:
      - .:/app
    networks:
      - mcp_network
    environment:
      - PORT=8000
      - MCP_TRANSPORT=sse
      - PYTHONPATH=/app
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_network.server" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/sse" ]
      interval: 30s
      retries: 3
    restart: unless-stopped

  # Fleet of 8 - Container #4: sanctuary_git (Task 130)
  sanctuary_git:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_git/Dockerfile
    container_name: sanctuary_git
    ports:
      - "8103:8000"
    volumes:
      - .:/app
    networks:
      - mcp_network
    environment:
      - PORT=8000
      - MCP_TRANSPORT=sse
      - PYTHONPATH=/app
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME:-Sanctuary Agent}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL:-agent@sanctuary.project}
      - GIT_COMMITTER_NAME=${GIT_AUTHOR_NAME:-Sanctuary Agent}
      - GIT_COMMITTER_EMAIL=${GIT_AUTHOR_EMAIL:-agent@sanctuary.project}
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_git.server" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/sse" ]
      interval: 30s
      retries: 3
    restart: unless-stopped

  # Fleet of 8 - Container #5: sanctuary_cortex (Task 131)
  sanctuary_cortex:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_cortex/Dockerfile
    container_name: sanctuary_cortex
    ports:
      - "8104:8000"
    volumes:
      - .:/app
    environment:
      - PROJECT_ROOT=/app
      - PYTHONPATH=/app
      - PORT=8000
      - MCP_TRANSPORT=sse
      - CHROMA_HOST=vector_db
      - CHROMA_PORT=8000
      - OLLAMA_HOST=http://ollama_model_mcp:11434
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
    networks:
      - mcp_network
    depends_on:
      - vector_db
      - ollama_model_mcp
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_cortex.server" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/sse" ]
      interval: 30s
      retries: 3
    restart: unless-stopped

  # Fleet of 8 - Container #6: sanctuary_domain (ADR 061)
  # Hosting: Chronicle, Protocol, Task, ADR, and Python Dev Tools
  sanctuary_domain:
    build:
      context: .
      dockerfile: mcp_servers/gateway/clusters/sanctuary_domain/Dockerfile
    container_name: sanctuary_domain
    ports:
      - "8105:8105"
    volumes:
      # Mount project root to allow tools to access all files (linting, etc.)
      - .:/app
    networks:
      - mcp_network
    environment:
      - PROJECT_ROOT=/app
      - PORT=8105
      - MCP_TRANSPORT=sse
      - MCP_GATEWAY_URL=https://mcp_gateway:4444
      - MCPGATEWAY_BEARER_TOKEN=${MCPGATEWAY_BEARER_TOKEN}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: '512M'
    command: [ "python", "-m", "mcp_servers.gateway.clusters.sanctuary_domain.server" ]
    restart: unless-stopped

networks:
  mcp_network:
    # bridge driver required for container-to-container communication
    driver: bridge
    external: true
    name: mcp_network
